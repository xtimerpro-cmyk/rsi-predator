<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RSI DIVERGENCE PREDATOR ‚Äî GM Capital</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/globe.gl"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
<style>
:root{--bg:#0a0a0f;--bg2:#0f1018;--bg3:#151520;--card:#12121c;--hover:#1a1a2e;--brd:#1e1e30;--brd2:#2a2a45;--t1:#e8e8f0;--t2:#8888a0;--t3:#55556a;--grn:#00e676;--red:#ff3d5a;--amb:#ffab00;--blu:#448aff;--cyn:#18ffff;--pur:#7c4dff;--grn2:#00e67633;--red2:#ff3d5a33;--amb2:#ffab0033;--blu2:#448aff33}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'JetBrains Mono',monospace;background:var(--bg);color:var(--t1);overflow:hidden;height:100vh;display:flex;flex-direction:column}

/* TOPBAR */
.topbar{display:flex;align-items:center;justify-content:space-between;padding:0 24px;height:48px;background:var(--bg2);border-bottom:1px solid var(--brd);flex-shrink:0}
.topbar-left{display:flex;align-items:center;gap:16px}
.logo{font-family:'Outfit',sans-serif;font-weight:900;font-size:13px;letter-spacing:3px;color:var(--cyn);text-shadow:0 0 10px #18ffff44}
.logo-sub{font-family:'Outfit',sans-serif;font-size:8px;letter-spacing:2px;color:var(--t3);margin-top:1px}
.topbar-divider{width:1px;height:24px;background:var(--brd)}
.sys{display:flex;align-items:center;gap:6px;font-size:10px;color:var(--t3);letter-spacing:1px}
.dot{width:6px;height:6px;border-radius:50%;background:var(--amb);box-shadow:0 0 12px #ffab0044;animation:pls 2s infinite}
.dot.live{background:var(--grn);box-shadow:0 0 12px #00e67644}
@keyframes pls{0%,100%{opacity:1}50%{opacity:.4}}
.topbar-right{display:flex;align-items:center;gap:16px;font-size:11px;color:var(--t2)}
.clock{font-variant-numeric:tabular-nums;color:var(--t1);font-weight:500}
.rbtn{padding:4px 10px;border:1px solid var(--brd);border-radius:3px;background:0;color:var(--t2);font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer;display:flex;align-items:center;gap:5px}
.rbtn:hover{border-color:var(--cyn);color:var(--cyn)}

/* TICKER TAPE */
.tape{height:46px;overflow:hidden;border-bottom:1px solid var(--brd);background:var(--bg2);flex-shrink:0}

/* TABS */
.tabs{display:flex;height:40px;background:var(--bg2);border-bottom:1px solid var(--brd);padding:0 24px;flex-shrink:0}
.tab{padding:0 20px;height:100%;display:flex;align-items:center;font-family:'Outfit',sans-serif;font-size:11px;font-weight:600;letter-spacing:2px;color:var(--t3);cursor:pointer;border-bottom:2px solid transparent;gap:6px;transition:.15s;user-select:none}
.tab:hover{color:var(--t1);background:var(--hover)}
.tab.on{color:var(--cyn);border-bottom-color:var(--cyn)}

/* TAB CONTENT - use visibility instead of display for Globe.gl */
.tab-area{flex:1;position:relative;overflow:hidden}
.tcon{position:absolute;top:0;left:0;width:100%;height:100%;visibility:hidden;pointer-events:none;display:flex;flex-direction:column}
.tcon.on{visibility:visible;pointer-events:auto;z-index:1}

/* RIBBON */
.ribbon{display:flex;height:36px;background:var(--bg3);border-bottom:1px solid var(--brd);overflow-x:auto;flex-shrink:0}
.ri{display:flex;align-items:center;gap:8px;padding:0 20px;height:100%;border-right:1px solid var(--brd);font-size:11px;white-space:nowrap}
.rl{color:var(--t3);font-size:9px;letter-spacing:1px;text-transform:uppercase}
.rv{font-weight:600;font-variant-numeric:tabular-nums}

.tape-item{font-family:'JetBrains Mono',monospace;font-size:11px;letter-spacing:0.5px;color:#8888a0;display:flex;align-items:center;gap:6px;white-space:nowrap}
.tape-item .tp{font-weight:700;color:#e8e8f0}
.tape-item .tpch{font-size:10px;margin-left:4px}
.tape-sep{color:#2a2a45;font-size:10px}


/* PORTFOLIO & WATCHLIST */
#pf-table td,#wl-table td{padding:6px 8px;border-bottom:1px solid #0e0e1a;font-family:'JetBrains Mono',monospace;font-size:11px;color:#c8c8d8;vertical-align:middle}
#pf-table tr:hover,#wl-table tr:hover{background:#ffffff06}
#pf-table input,#wl-table input{background:#0a0a14;border:1px solid #1e1e30;color:#e8e8f0;padding:4px 8px;border-radius:3px;font-family:'JetBrains Mono',monospace;font-size:11px;width:90px;outline:none}
#pf-table input:focus,#wl-table input:focus{border-color:#18ffff66}
#wl-table input.notes-input{width:140px}
.pf-del,.wl-del{background:none;border:none;color:#ff3d5a88;cursor:pointer;font-size:14px;padding:2px 6px;border-radius:3px}
.pf-del:hover,.wl-del:hover{background:#ff3d5a22;color:#ff3d5a}
.signal-bull{color:#00e676;font-weight:700;font-size:10px;letter-spacing:1px}
.signal-bear{color:#ff3d5a;font-weight:700;font-size:10px;letter-spacing:1px}
.signal-neutral{color:#8888a0;font-size:10px;letter-spacing:1px}

/* DROPS */
.dl{display:grid;grid-template-columns:260px 1fr 300px;flex:1;gap:1px;background:var(--brd);overflow:hidden}
.pn{background:var(--bg2);display:flex;flex-direction:column;overflow:hidden}
.ph{padding:14px 16px;border-bottom:1px solid var(--brd);font-family:'Outfit',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;color:var(--t3);display:flex;justify-content:space-between}
.fs{padding:12px 16px;border-bottom:1px solid var(--brd)}
.fl{font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--t3);margin-bottom:8px}
.fg{display:flex;flex-wrap:wrap;gap:5px}
.fb{padding:4px 8px;border:1px solid var(--brd);border-radius:3px;background:0;color:var(--t2);font-family:'JetBrains Mono',monospace;font-size:9px;cursor:pointer;transition:.15s}
.fb:hover{border-color:var(--brd2);color:var(--t1)}
.fb.on{border-color:var(--cyn);color:var(--cyn);background:rgba(24,255,255,.05)}
.fb.g.on{border-color:var(--grn);color:var(--grn);background:var(--grn2)}
.fb.r.on{border-color:var(--red);color:var(--red);background:var(--red2)}
.sinp{width:100%;padding:7px 10px;border:1px solid var(--brd);border-radius:3px;background:var(--bg);color:var(--t1);font-family:'JetBrains Mono',monospace;font-size:11px;outline:0}
.sinp:focus{border-color:var(--cyn)}.sinp::placeholder{color:var(--t3)}
.pc{background:var(--bg);overflow:hidden;display:flex;flex-direction:column}
.tw{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--brd2) transparent}
table{width:100%;border-collapse:collapse;font-size:11px}
thead{position:sticky;top:0;z-index:10}
th{padding:8px 10px;text-align:left;font-size:8px;font-weight:600;text-transform:uppercase;letter-spacing:1.5px;color:var(--t3);background:var(--bg3);border-bottom:1px solid var(--brd);white-space:nowrap}
tbody tr{border-bottom:1px solid var(--brd);cursor:pointer;transition:.1s}
tbody tr:hover{background:var(--hover)}
tbody tr.sel{background:rgba(24,255,255,.03);border-left:2px solid var(--cyn)}
td{padding:8px 10px;font-variant-numeric:tabular-nums;white-space:nowrap}
.tk{font-weight:700;font-family:'Outfit',sans-serif;font-size:12px}
.ex{font-size:7px;padding:2px 4px;border-radius:2px;margin-left:5px;font-weight:500;letter-spacing:1px}
.ex.us{background:var(--blu2);color:var(--blu)}.ex.pa{background:rgba(124,77,255,.2);color:var(--pur)}
.db{display:inline-flex;padding:2px 6px;border-radius:3px;font-size:9px;font-weight:600}
.db.bu{background:var(--grn2);color:var(--grn)}.db.be{background:var(--red2);color:var(--red)}
.sb{display:inline-flex;padding:2px 6px;border-radius:3px;font-size:9px;font-weight:600}
.sb.dt{background:var(--amb2);color:var(--amb)}.sb.cf{background:var(--grn2);color:var(--grn)}
.de{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--t3);font-size:11px;gap:10px}
.dei{font-size:28px;opacity:.3}
.dtn{font-family:'Outfit',sans-serif;font-size:22px;font-weight:800}
.dts{font-size:9px;color:var(--t3);margin-top:3px;letter-spacing:1px}
.dg{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--brd);border-bottom:1px solid var(--brd)}
.dc{padding:10px 14px;background:var(--bg2)}
.dcl{font-size:8px;text-transform:uppercase;letter-spacing:1.5px;color:var(--t3);margin-bottom:3px}
.dcv{font-size:15px;font-weight:600}
.rg{padding:14px 16px;border-bottom:1px solid var(--brd)}
.rgb{height:5px;background:var(--bg);border-radius:3px;position:relative;margin-top:6px}
.rgf{height:100%;border-radius:3px;transition:.5s}
.rgm{position:absolute;top:-3px;width:2px;height:11px;background:#fff;transform:translateX(-50%);box-shadow:0 0 4px rgba(255,255,255,.3)}
.rgl{display:flex;justify-content:space-between;margin-top:5px;font-size:7px;color:var(--t3)}
.dtl{padding:14px 16px;flex:1;overflow-y:auto}
.ti{display:flex;gap:10px;padding:8px 0;border-bottom:1px solid var(--brd);font-size:10px}
.td2{width:7px;height:7px;border-radius:50%;margin-top:3px;flex-shrink:0}
.da{padding:12px 16px;border-top:1px solid var(--brd)}
.ab{width:100%;padding:8px;border:none;border-radius:3px;background:var(--cyn);color:var(--bg);font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer;font-weight:700;letter-spacing:1px}
.ab:hover{opacity:.85}

/* GLOBE CONTAINER */
#gc{width:100%;height:100%;position:relative;background:#000005;overflow:hidden}

/* ===== HUD SYSTEM ===== */
#hud-top{position:absolute;top:0;left:0;right:0;z-index:50;display:flex;height:56px;background:linear-gradient(180deg,#0a0a12ee 0%,#0a0a1200 100%);border-bottom:1px solid #18ffff15;padding:0 16px;gap:0;align-items:stretch}
.hud-metric{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:6px 8px;border-right:1px solid #ffffff08;position:relative}
.hud-metric:last-child{border-right:0}
.hud-label{font-size:7px;letter-spacing:2px;color:var(--t3);font-weight:600;margin-bottom:2px}
.hud-val{font-family:'Outfit',sans-serif;font-size:18px;font-weight:800;line-height:1}
.hud-bar{width:60px;height:3px;background:#ffffff08;border-radius:2px;margin-top:3px;overflow:hidden}
.hud-bar-fill{height:100%;border-radius:2px;transition:width .8s ease}
.hud-bar-grn{background:var(--grn);box-shadow:0 0 8px var(--grn)}
.hud-bar-red{background:var(--red);box-shadow:0 0 8px var(--red)}

#hud-left{position:absolute;top:64px;left:0;bottom:120px;width:200px;z-index:50;background:linear-gradient(90deg,#0a0a12dd 0%,#0a0a1200 100%);overflow-y:auto;scrollbar-width:none;padding:8px 0}
#hud-left::-webkit-scrollbar{display:none}

#hud-right{position:absolute;top:64px;right:0;bottom:120px;width:220px;z-index:50;background:linear-gradient(-90deg,#0a0a12dd 0%,#0a0a1200 100%);overflow-y:auto;scrollbar-width:none;padding:8px 0}
#hud-right::-webkit-scrollbar{display:none}

#hud-bottom{position:absolute;bottom:0;left:0;right:0;z-index:50;height:110px;background:linear-gradient(0deg,#0a0a12ee 0%,#0a0a1200 100%);border-top:1px solid #18ffff15;display:flex;align-items:center;justify-content:center;gap:0;padding:0 12px}

.hud-panel-title{font-family:'Outfit',sans-serif;font-size:8px;font-weight:700;letter-spacing:2px;color:var(--t3);padding:4px 12px 8px;border-bottom:1px solid #ffffff08}

.hud-rank-item{display:flex;align-items:center;gap:8px;padding:6px 12px;cursor:pointer;transition:.15s;font-size:10px;border-bottom:1px solid #ffffff05}
.hud-rank-item:hover{background:#18ffff08}
.hud-rank-pos{font-family:'Outfit',sans-serif;font-weight:900;font-size:14px;width:20px;text-align:center}
.hud-rank-bar{flex:1;height:4px;background:#ffffff08;border-radius:2px;overflow:hidden}
.hud-rank-fill{height:100%;border-radius:2px;transition:width 1s ease}
.hud-rank-count{font-weight:700;font-size:11px;min-width:30px;text-align:right}

.hud-feed-item{padding:5px 12px;font-size:9px;border-bottom:1px solid #ffffff05;cursor:pointer;transition:.15s;display:flex;justify-content:space-between;align-items:center}
.hud-feed-item:hover{background:#18ffff08}
.hud-feed-ticker{font-family:'Outfit',sans-serif;font-weight:800;font-size:11px}
.hud-feed-badge{font-size:7px;padding:1px 5px;border-radius:3px;font-weight:700}
.hud-feed-rsi{font-weight:700;font-size:11px}
.hud-feed-time{font-size:7px;color:var(--t3)}

.hud-gauge{display:flex;flex-direction:column;align-items:center;width:100px;padding:8px 4px}
.hud-gauge-label{font-size:7px;letter-spacing:1.5px;color:var(--t3);font-weight:600;margin-top:2px}
.hud-gauge-val{font-family:'Outfit',sans-serif;font-size:16px;font-weight:800}
.hud-bottom-center{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;max-width:400px}

.gc-btn{padding:4px 8px;border:1px solid var(--brd);border-radius:3px;background:#0a0a12dd;color:var(--t2);font-family:'JetBrains Mono',monospace;font-size:8px;cursor:pointer;transition:.2s;letter-spacing:0.5px}
.gc-btn:hover{border-color:var(--cyn);color:var(--cyn);box-shadow:0 0 10px rgba(24,255,255,.1)}
.gc-btn:active{transform:scale(0.95)}
.gc-btn-reset{border-color:var(--amb);color:var(--amb)}
.gc-btn-reset:hover{border-color:var(--amb);color:var(--amb);box-shadow:0 0 10px rgba(255,171,0,.1)}
.gs-item{padding:6px 10px;cursor:pointer;transition:.15s;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--brd)}
.gs-item:hover{background:var(--hover)}

@keyframes fadeInUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.hud-rank-item,.hud-feed-item{animation:fadeInUp .3s ease both}

/* EXCHANGE PANEL */
.mep{position:absolute;top:0;right:0;width:380px;height:100%;background:var(--bg2)ee;border-left:1px solid var(--brd);z-index:60;display:none;flex-direction:column;overflow:hidden;backdrop-filter:blur(10px)}
.mep.on{display:flex}
.meph{padding:16px;border-bottom:1px solid var(--brd);display:flex;justify-content:space-between;align-items:center}
.mept{font-family:'Outfit',sans-serif;font-size:16px;font-weight:800}
.mepc{background:0;border:1px solid var(--brd);border-radius:3px;color:var(--t3);padding:4px 10px;cursor:pointer;font-family:'JetBrains Mono',monospace;font-size:10px}
.mepc:hover{color:var(--cyn);border-color:var(--cyn)}
.meps{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1px;background:var(--brd);border-bottom:1px solid var(--brd)}
.mepsi{background:var(--bg2);padding:12px;text-align:center}
.mepsi .n{font-size:20px;font-weight:700}
.mepsi .l{font-size:8px;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-top:2px}
.mepl{flex:1;overflow-y:auto}
.mepi{padding:10px 16px;border-bottom:1px solid var(--brd);display:flex;justify-content:space-between;align-items:center;cursor:pointer;font-size:10px;transition:.1s}
.mepi:hover{background:var(--hover)}

.range-label{display:flex;justify-content:space-between;font-size:9px;letter-spacing:1px;color:var(--t2);margin-bottom:6px}
.rv2{color:var(--t1);font-weight:600}
.range-track{position:relative;height:28px;display:flex;align-items:center}
.range-fill{position:absolute;height:3px;background:var(--cyan);border-radius:2px;pointer-events:none;top:50%;transform:translateY(-50%)}
.range-input{-webkit-appearance:none;appearance:none;width:100%;height:3px;background:#1e1e30;border-radius:2px;position:absolute;top:50%;transform:translateY(-50%);pointer-events:auto;margin:0}
.range-input::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--cyan);cursor:pointer;border:2px solid #0a0a0f;box-shadow:0 0 6px #18ffff44}
.range-input::-moz-range-thumb{width:14px;height:14px;border-radius:50%;background:var(--cyan);cursor:pointer;border:2px solid #0a0a0f}

/* SECTORS */

/* SECTORS BUBBLE VIS */
#scon{position:relative;width:100%;height:100%;overflow:hidden;background:radial-gradient(ellipse at center,#0d0d18 0%,#070710 100%)}
#scon canvas{position:absolute;top:0;left:0;pointer-events:none;z-index:0}
#bubble-svg{width:100%;height:100%;position:absolute;top:0;left:0;z-index:1}
.sector-tooltip{position:absolute;background:#12121cee;border:1px solid #2a2a45;border-radius:6px;padding:10px 14px;pointer-events:none;z-index:100;font-size:10px;color:#e8e8f0;backdrop-filter:blur(8px);opacity:0;transition:opacity .15s;max-width:220px}
.sector-tooltip.show{opacity:1}
.sector-tooltip .tt-name{font-family:Outfit;font-weight:800;font-size:13px;letter-spacing:1px;margin-bottom:4px}
.sector-tooltip .tt-row{display:flex;justify-content:space-between;gap:12px;padding:1px 0}
.sector-tooltip .tt-label{color:#8888a0}
.sector-tooltip .tt-val{font-weight:700}
.sector-breadcrumb{position:absolute;top:12px;left:12px;z-index:50;display:flex;gap:6px;align-items:center}
.sector-breadcrumb .bc-item{font-family:Outfit;font-size:9px;font-weight:700;letter-spacing:1.5px;color:#8888a0;cursor:pointer;padding:3px 10px;border:1px solid #1e1e30;border-radius:3px;transition:.15s}
.sector-breadcrumb .bc-item:hover{border-color:#18ffff;color:#18ffff}
.sector-breadcrumb .bc-item.active{color:#18ffff;border-color:#18ffff44;background:#18ffff11}
.sector-breadcrumb .bc-sep{color:#55556a;font-size:8px}
.sector-legend{position:absolute;bottom:12px;right:12px;z-index:50;display:flex;gap:12px;font-size:8px;color:#8888a0;font-family:Outfit;letter-spacing:1px}
.sector-legend .lg-item{display:flex;align-items:center;gap:4px}
.sector-legend .lg-dot{width:8px;height:8px;border-radius:50%}
.sector-stats-bar{position:absolute;top:12px;right:12px;z-index:50;display:flex;gap:8px}
.sector-stats-bar .ss-card{background:#12121ccc;border:1px solid #1e1e30;border-radius:4px;padding:6px 12px;text-align:center;backdrop-filter:blur(6px)}
.sector-stats-bar .ss-val{font-family:Outfit;font-weight:900;font-size:16px;line-height:1}
.sector-stats-bar .ss-lbl{font-size:7px;letter-spacing:1.5px;color:#8888a0;margin-top:2px}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
</head>
<body>

<div class="topbar">
<div class="topbar-left">
  <div><div class="logo">RSI DIVERGENCE PREDATOR</div><div class="logo-sub">powered by GM Capital</div></div>
  <div class="topbar-divider"></div>
  <div class="sys"><div class="dot" id="sd"></div><span id="st">LOADING</span></div>
</div>
<div class="topbar-right">
  <span class="scaninfo" id="si2">‚Äî</span>
  <span class="lu" id="lu">‚Äî</span>
  <button class="rbtn" onclick="loadData()"><span>‚Üª</span> REFRESH</button>
  <span class="clock" id="ck">--:--:--</span>
</div>
</div>

<div class="tape" style="display:flex;align-items:center;overflow:hidden">
<div style="flex:1;overflow:hidden">
<div class="tradingview-widget-container"><div class="tradingview-widget-container__widget"></div>
<script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>{"symbols":[{"proName":"FOREXCOM:SPXUSD","title":"S&P 500"},{"proName":"FOREXCOM:NSXUSD","title":"NASDAQ"},{"proName":"BITSTAMP:BTCUSD","title":"BTC"},{"proName":"FX:EURUSD","title":"EUR/USD"}],"showSymbolLogo":false,"isTransparent":true,"displayMode":"adaptive","colorTheme":"dark","locale":"en"}</script></div>
</div>
<div style="display:flex;gap:20px;padding:0 16px;align-items:center;flex-shrink:0;border-left:1px solid #1e1e30">
  <div class="tape-item" id="ti-gold">Gold <span class="tp">‚Äî</span></div>
  <div class="tape-sep">|</div>
  <div class="tape-item" id="ti-oil">Oil <span class="tp">‚Äî</span></div>
  <div class="tape-sep">|</div>
  <div class="tape-item" id="ti-vix">VIX <span class="tp">‚Äî</span></div>
  <div class="tape-sep">|</div>
  <div class="tape-item" id="ti-dax">DAX <span class="tp">‚Äî</span></div>
  <div class="tape-sep">|</div>
  <div class="tape-item" id="ti-cac">CAC 40 <span class="tp">‚Äî</span></div>
</div>
</div>

<div class="tabs">
  <div class="tab on" data-tab="drops">üìä FRESH DROPS</div>
  <div class="tab" onclick="window.location.href='/globe.html'">üåê GLOBE</div>
  <div class="tab" data-tab="sectors">üè≠ SECTORS</div>
  <div class="tab" data-tab="portfolio">üíº PORTFOLIO</div>
  <div class="tab" data-tab="watchlist">üëÅ WATCHLIST</div>
</div>

<div class="tab-area">
<!-- DROPS -->
<div class="tcon on" id="tab-drops">
<div class="ribbon">
  <div class="ri"><span class="rl">Active</span><span class="rv" style="color:var(--amb)" id="sa">‚Äî</span></div>
  <div class="ri"><span class="rl">Confirmed</span><span class="rv" style="color:var(--grn)" id="sc2">‚Äî</span></div>
  <div class="ri"><span class="rl">Bull</span><span class="rv" style="color:var(--grn)" id="sbu">‚Äî</span><span style="color:var(--t3);margin:0 4px">/</span><span class="rl">Bear</span><span class="rv" style="color:var(--red)" id="sbe">‚Äî</span></div>
  <div class="ri"><span class="rl">Total</span><span class="rv" style="color:var(--blu)" id="sto">‚Äî</span></div>
</div>
<div class="dl">
  <div class="pn">
    <div class="ph">FILTERS</div>
    <div class="fs"><div class="fl">Search</div><input class="sinp" placeholder="TICKER..." id="sinp"></div>
    <div class="fs"><div class="fl">Status</div><div class="fg">
      <button class="fb on" style="border-color:var(--amb);color:var(--amb)" data-f="s" data-v="detected">DETECTED</button>
      <button class="fb g on" data-f="s" data-v="confirmed">CONFIRMED</button>
    </div></div>
    <div class="fs"><div class="fl">Type</div><div class="fg">
      <button class="fb g on" data-f="t" data-v="bullish">‚ñ≤ BULL</button>
      <button class="fb r on" data-f="t" data-v="bearish">‚ñº BEAR</button>
    </div></div>
    <div class="fs"><div class="fl">Exchange</div><div class="fg" id="ef"></div></div>
    <div class="fs">
      <div class="range-label"><span>RSI RANGE</span><span class="rv2"><span id="rsi-min-val">0</span> &mdash; <span id="rsi-max-val">100</span></span></div>
      <div class="range-track"><div class="range-fill" id="rsi-fill"></div>
        <input type="range" class="range-input" id="rsi-min" min="0" max="100" value="0">
        <input type="range" class="range-input" id="rsi-max" min="0" max="100" value="100">
      </div>
    </div>
    <div class="fs">
      <div class="range-label"><span>PRICE RANGE</span><span class="rv2">$<span id="price-min-val">0</span> &mdash; $<span id="price-max-val">200</span></span></div>
      <div class="range-track"><div class="range-fill" id="price-fill"></div>
        <input type="range" class="range-input" id="price-min" min="0" max="10000" value="0">
        <input type="range" class="range-input" id="price-max" min="0" max="200" value="200">
      </div>
    </div>
  </div>
  <div class="pc">
    <div class="ph"><span>DROPS</span><span style="color:var(--t3);font-weight:400" id="rc">‚Äî</span></div>
    <div class="tw"><table><thead><tr><th class="sortable" data-sort="ticker">TICKER</th><th class="sortable" data-sort="type">TYPE</th><th class="sortable" data-sort="status">STATUS</th><th class="sortable" data-sort="prev_rsi">RSI P</th><th class="sortable" data-sort="curr_rsi">RSI D</th><th class="sortable" data-sort="rsi_current">RSI NOW</th><th class="sortable" data-sort="curr_price">PRICE</th><th class="sortable" data-sort="date_detected">DATE</th></tr></thead><tbody id="tb"></tbody></table></div>
  </div>
  <div class="pn">
    <div class="ph">DETAIL</div>
    <div id="dp"><div class="de"><div class="dei">‚óé</div><span>SELECT A DROP</span></div></div>
  </div>
</div>
</div>

<!-- GLOBE -->
<div class="tcon" id="tab-map">
  <div id="gc">
    <!-- ====== TOP HUD BAR ====== -->
    <div id="hud-top">
      <div class="hud-metric">
        <div class="hud-label">DIVERGENCES DETECTED</div>
        <div class="hud-val" id="h-total" style="color:var(--cyn)">‚Äî</div>
      </div>
      <div class="hud-metric">
        <div class="hud-label">BULL SIGNALS</div>
        <div class="hud-val" style="color:var(--grn)" id="h-bull">‚Äî</div>
        <div class="hud-bar"><div class="hud-bar-fill hud-bar-grn" id="h-bull-bar"></div></div>
      </div>
      <div class="hud-metric">
        <div class="hud-label">BEAR SIGNALS</div>
        <div class="hud-val" style="color:var(--red)" id="h-bear">‚Äî</div>
        <div class="hud-bar"><div class="hud-bar-fill hud-bar-red" id="h-bear-bar"></div></div>
      </div>
      <div class="hud-metric">
        <div class="hud-label">SENTIMENT</div>
        <div class="hud-val" id="h-sent">‚Äî</div>
      </div>
      <div class="hud-metric">
        <div class="hud-label">EXCHANGES</div>
        <div class="hud-val" style="color:var(--pur)" id="h-exc">‚Äî</div>
      </div>
      <div class="hud-metric">
        <div class="hud-label">CONFIRMED RATE</div>
        <div class="hud-val" style="color:var(--amb)" id="h-rate">‚Äî</div>
      </div>
    </div>

    <!-- ====== LEFT: EXCHANGE LEADERBOARD ====== -->
    <div id="hud-left">
      <div class="hud-panel-title">üèÜ EXCHANGE RANKING</div>
      <div id="hud-ranking"></div>
    </div>

    <!-- ====== RIGHT: LIVE FEED ====== -->
    <div id="hud-right">
      <div class="hud-panel-title">‚ö° LATEST DROPS</div>
      <div id="hud-feed"></div>
    </div>

    <!-- ====== BOTTOM: GAUGES ====== -->
    <div id="hud-bottom">
      <div class="hud-gauge" id="hud-g1">
        <canvas id="gauge-bull" width="100" height="60"></canvas>
        <div class="hud-gauge-label">BULL RATIO</div>
        <div class="hud-gauge-val" id="gv-bull">‚Äî</div>
      </div>
      <div class="hud-gauge" id="hud-g2">
        <canvas id="gauge-conf" width="100" height="60"></canvas>
        <div class="hud-gauge-label">CONFIRM RATE</div>
        <div class="hud-gauge-val" id="gv-conf">‚Äî</div>
      </div>
      <div class="hud-bottom-center">
        <div style="display:flex;flex-wrap:wrap;gap:4px;justify-content:center">
          <button class="gc-btn" onclick="flyTo(40.71,-74.01,'US')">üá∫üá∏ US</button>
          <button class="gc-btn" onclick="flyTo(48.86,2.35,'EU')">üá™üá∫ EU</button>
          <button class="gc-btn" onclick="flyTo(51.51,-0.13,'UK')">üá¨üáß UK</button>
          <button class="gc-btn" onclick="flyTo(35.68,139.65,'JP')">üáØüáµ JP</button>
          <button class="gc-btn" onclick="flyTo(31.23,121.47,'CN')">üá®üá≥ CN</button>
          <button class="gc-btn" onclick="flyTo(19.08,72.88,'IN')">üáÆüá≥ IN</button>
          <button class="gc-btn" onclick="flyTo(-33.87,151.21,'AU')">üá¶üá∫ AU</button>
          <button class="gc-btn" onclick="flyTo(-23.55,-46.63,'BR')">üáßüá∑ BR</button>
          <button class="gc-btn gc-btn-reset" onclick="flyReset()">‚ü≤ RESET</button>
        </div>
        <div style="position:relative;margin-top:6px">
          <input type="text" id="globe-search" class="sinp" placeholder="üîç Search exchange..." style="width:220px;font-size:10px;padding:5px 10px;background:#0a0a12dd;text-align:center;border-color:var(--brd2)">
          <div id="globe-search-results" style="display:none;position:absolute;bottom:100%;left:50%;transform:translateX(-50%);width:250px;background:#0f1018ee;border:1px solid var(--brd);border-radius:4px;max-height:200px;overflow-y:auto;backdrop-filter:blur(8px);margin-bottom:4px"></div>
        </div>
      </div>
      <div class="hud-gauge" id="hud-g3">
        <canvas id="gauge-rsi" width="100" height="60"></canvas>
        <div class="hud-gauge-label">AVG RSI</div>
        <div class="hud-gauge-val" id="gv-rsi">‚Äî</div>
      </div>
      <div class="hud-gauge" id="hud-g4">
        <canvas id="gauge-heat" width="100" height="60"></canvas>
        <div class="hud-gauge-label">ACTIVITY</div>
        <div class="hud-gauge-val" id="gv-heat">‚Äî</div>
      </div>
    </div>

    <!-- Exchange panel -->
    <div class="mep" id="mep"></div>
  </div>
</div>

<!-- SECTORS -->
<div class="tcon" id="tab-sectors">
  <div id="scon">
    <div class="sector-breadcrumb" id="bc"><span class="bc-item active" onclick="resetBubbles()">ALL SECTORS</span></div>
    <div class="sector-stats-bar" id="sstats"></div>
    <div class="sector-tooltip" id="stooltip"></div>
    <div class="sector-legend"><div class="lg-item"><div class="lg-dot" style="background:#00e676"></div>BULLISH</div><div class="lg-item"><div class="lg-dot" style="background:#ff3d5a"></div>BEARISH</div><div class="lg-item"><div class="lg-dot" style="background:#ffab00"></div>MIXED</div></div>
    <svg id="bubble-svg"></svg>
  </div>
</div>

<!-- PORTFOLIO -->
<div class="tcon" id="tab-portfolio">
  <div style="padding:16px;height:100%;display:flex;flex-direction:column;overflow:hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="display:flex;align-items:center;gap:12px">
        <span style="font-family:Outfit;font-weight:800;font-size:14px;letter-spacing:2px;color:var(--cyan)">PORTFOLIO</span>
        <span id="pf-total" style="font-family:'JetBrains Mono';font-size:12px;color:#8888a0">$0.00</span>
        <span id="pf-pnl" style="font-family:'JetBrains Mono';font-size:11px"></span>
      </div>
      <div style="display:flex;gap:8px">
        <button onclick="addPfRow()" style="background:#18ffff22;border:1px solid #18ffff44;color:#18ffff;padding:4px 14px;border-radius:3px;font-family:Outfit;font-size:10px;font-weight:700;letter-spacing:1px;cursor:pointer">+ ADD</button>
        <button onclick="clearPf()" style="background:#ff3d5a22;border:1px solid #ff3d5a44;color:#ff3d5a;padding:4px 14px;border-radius:3px;font-family:Outfit;font-size:10px;font-weight:700;letter-spacing:1px;cursor:pointer">CLEAR</button>
      </div>
    </div>
    <div style="flex:1;overflow-y:auto">
      <table style="width:100%;border-collapse:collapse" id="pf-table">
        <thead><tr style="border-bottom:1px solid #1e1e30;font-size:8px;letter-spacing:1.5px;color:#8888a0;text-align:left">
          <th style="padding:6px 8px;width:30px">#</th>
          <th style="padding:6px 8px">TICKER</th>
          <th style="padding:6px 8px">QTY</th>
          <th style="padding:6px 8px">BUY PRICE</th>
          <th style="padding:6px 8px">CURRENT</th>
          <th style="padding:6px 8px">VALUE</th>
          <th style="padding:6px 8px">P&L</th>
          <th style="padding:6px 8px">P&L %</th>
          <th style="padding:6px 8px;width:30px"></th>
        </tr></thead>
        <tbody id="pf-body"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- WATCHLIST -->
<div class="tcon" id="tab-watchlist">
  <div style="padding:16px;height:100%;display:flex;flex-direction:column;overflow:hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="display:flex;align-items:center;gap:12px">
        <span style="font-family:Outfit;font-weight:800;font-size:14px;letter-spacing:2px;color:#e040fb">WATCHLIST</span>
        <span id="wl-count" style="font-family:'JetBrains Mono';font-size:12px;color:#8888a0">0 items</span>
      </div>
      <div style="display:flex;gap:8px">
        <button onclick="addWlRow()" style="background:#e040fb22;border:1px solid #e040fb44;color:#e040fb;padding:4px 14px;border-radius:3px;font-family:Outfit;font-size:10px;font-weight:700;letter-spacing:1px;cursor:pointer">+ ADD</button>
        <button onclick="clearWl()" style="background:#ff3d5a22;border:1px solid #ff3d5a44;color:#ff3d5a;padding:4px 14px;border-radius:3px;font-family:Outfit;font-size:10px;font-weight:700;letter-spacing:1px;cursor:pointer">CLEAR</button>
      </div>
    </div>
    <div style="flex:1;overflow-y:auto">
      <table style="width:100%;border-collapse:collapse" id="wl-table">
        <thead><tr style="border-bottom:1px solid #1e1e30;font-size:8px;letter-spacing:1.5px;color:#8888a0;text-align:left">
          <th style="padding:6px 8px;width:30px">#</th>
          <th style="padding:6px 8px">TICKER</th>
          <th style="padding:6px 8px">TARGET BUY</th>
          <th style="padding:6px 8px">TARGET SELL</th>
          <th style="padding:6px 8px">CURRENT</th>
          <th style="padding:6px 8px">SIGNAL</th>
          <th style="padding:6px 8px">NOTES</th>
          <th style="padding:6px 8px;width:30px"></th>
        </tr></thead>
        <tbody id="wl-body"></tbody>
      </table>
    </div>
  </div>
</div>
</div>

<script>
let AD=[], myGlobe=null, globeInited=false;

const EXS=[
{c:'US',n:'NYSE / NASDAQ',ci:'New York',co:'USA',la:40.71,lo:-74.01,cl:'#448aff'},
{c:'PA',n:'Euronext Paris',ci:'Paris',co:'France',la:48.86,lo:2.35,cl:'#7c4dff'},
{c:'LSE',n:'London SE',ci:'London',co:'UK',la:51.51,lo:-0.13,cl:'#18ffff'},
{c:'XETRA',n:'Deutsche B√∂rse',ci:'Frankfurt',co:'Germany',la:50.11,lo:8.68,cl:'#ffab00'},
{c:'TSE',n:'Tokyo SE',ci:'Tokyo',co:'Japan',la:35.68,lo:139.65,cl:'#ff3d5a'},
{c:'HKEX',n:'Hong Kong SE',ci:'Hong Kong',co:'China',la:22.32,lo:114.17,cl:'#ff6e40'},
{c:'SSE',n:'Shanghai SE',ci:'Shanghai',co:'China',la:31.23,lo:121.47,cl:'#ff3d5a'},
{c:'BSE',n:'Bombay SE',ci:'Mumbai',co:'India',la:19.08,lo:72.88,cl:'#ffab00'},
{c:'TSX',n:'Toronto SE',ci:'Toronto',co:'Canada',la:43.65,lo:-79.38,cl:'#448aff'},
{c:'ASX',n:'Australian SE',ci:'Sydney',co:'Australia',la:-33.87,lo:151.21,cl:'#00e676'},
{c:'JSE',n:'Johannesburg SE',ci:'Johannesburg',co:'SA',la:-26.2,lo:28.05,cl:'#ffab00'},
{c:'B3',n:'B3 Brasil',ci:'S√£o Paulo',co:'Brazil',la:-23.55,lo:-46.63,cl:'#00e676'},
{c:'KRX',n:'Korea Exchange',ci:'Seoul',co:'S. Korea',la:37.57,lo:126.98,cl:'#448aff'},
{c:'SIX',n:'SIX Swiss',ci:'Zurich',co:'Switzerland',la:47.38,lo:8.54,cl:'#ff3d5a'},
{c:'BME',n:'Bolsa Madrid',ci:'Madrid',co:'Spain',la:40.42,lo:-3.7,cl:'#ffab00'},
{c:'MI',n:'Borsa Italiana',ci:'Milan',co:'Italy',la:45.46,lo:9.19,cl:'#00e676'},
{c:'AS',n:'Euronext Amsterdam',ci:'Amsterdam',co:'Netherlands',la:52.37,lo:4.9,cl:'#7c4dff'},
{c:'SGX',n:'Singapore Exchange',ci:'Singapore',co:'Singapore',la:1.35,lo:103.82,cl:'#18ffff'},
{c:'SA',n:'Saudi Exchange',ci:'Riyadh',co:'Saudi Arabia',la:24.71,lo:46.68,cl:'#00e676'},
{c:'IDX',n:'Indonesia SE',ci:'Jakarta',co:'Indonesia',la:-6.21,lo:106.85,cl:'#ff6e40'},
];

const SCC={'Technology':'#18ffff','Healthcare':'#00e676','Financial Services':'#448aff','Consumer Cyclical':'#7c4dff','Energy':'#ffab00','Industrials':'#ff3d5a','Consumer Defensive':'#8bc34a','Basic Materials':'#ff9800','Real Estate':'#e91e63','Communication Services':'#00bcd4','Utilities':'#9e9e9e','Unknown':'#55556a'};

// Clock
setInterval(()=>{document.getElementById('ck').textContent=new Date().toLocaleTimeString('en-US',{hour12:false})},1000);

// Tab switching
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('on'));
    document.querySelectorAll('.tcon').forEach(x=>x.classList.remove('on'));
    t.classList.add('on');
    const id='tab-'+t.dataset.tab;
    document.getElementById(id).classList.add('on');
    if(t.dataset.tab==='map') setTimeout(initGlobe,50);
    if(t.dataset.tab==='sectors') rS();
  });
});

// Load data from Flask API
async function loadData(){
  try{
    const r=await fetch('/api/drops');
    const d=await r.json();
    AD=d.drops||[];
    const det=AD.filter(x=>x.status==='detected').length;
    const conf=AD.filter(x=>x.status==='confirmed').length;
    const bulls=AD.filter(x=>(x.div_type||'').includes('bull')).length;
    document.getElementById('sa').textContent=det;
    document.getElementById('sc2').textContent=conf;
    document.getElementById('sbu').textContent=bulls;
    document.getElementById('sbe').textContent=AD.length-bulls;
    document.getElementById('sto').textContent=AD.length;
    document.getElementById('sd').classList.add('live');
    document.getElementById('st').textContent='ONLINE ¬∑ '+AD.length+' drops';
    document.getElementById('si2').innerHTML='<span style="color:var(--grn)">'+AD.length+'</span> DROPS';
    bEF(); aF();
    if(myGlobe){updGlobe();updGlobeStats();updArcs();}
  }catch(e){
    console.error('Load error',e);
    document.getElementById('st').textContent='OFFLINE';
  }
}

// Build exchange filters
function bEF(){
  const xs=[...new Set(AD.map(d=>d.exchange))].sort();
  const c=document.getElementById('ef');c.innerHTML='';
  xs.forEach(x=>{
    const b=document.createElement('button');b.className='fb on';b.dataset.f='e';b.dataset.v=x;b.textContent=x;
    b.onclick=()=>{b.classList.toggle('on');aF()};
    c.appendChild(b);
  });
}

// Filter state
const F={s:['detected','confirmed'],t:['bullish','bearish'],q:''};
document.querySelectorAll('.fb[data-f]').forEach(b=>b.addEventListener('click',()=>{
  b.classList.toggle('on');
  const f=b.dataset.f, v=b.dataset.v;
  if(f==='e') return;
  const a=f==='s'?F.s:F.t;
  if(b.classList.contains('on')){if(!a.includes(v))a.push(v)}
  else{const i=a.indexOf(v);if(i>-1)a.splice(i,1)}
  aF();
}));
document.getElementById('sinp').addEventListener('input',e=>{F.q=e.target.value.toUpperCase();aF()});

var currentSort={col:null,dir:null};
function aF(){
  const xs=[...document.querySelectorAll('#ef .fb.on')].map(b=>b.dataset.v);
  var rMn=+(document.getElementById('rsi-min').value)||0;
  var rMx=+(document.getElementById('rsi-max').value)||100;
  var pMn=+(document.getElementById('price-min').value)||0;
  var pMx=+(document.getElementById('price-max').value)||10000;
  var fd=AD.filter(d=>{
    if(F.q&&!(d.ticker||'').toUpperCase().includes(F.q))return false;
    if(!F.s.includes(d.status))return false;
    const ib=(d.div_type||'').includes('bull'),ie=(d.div_type||'').includes('bear');
    if(ib&&!F.t.includes('bullish'))return false;
    if(ie&&!F.t.includes('bearish'))return false;
    if(xs.length&&!xs.includes(d.exchange))return false;
    var rsi=d.rsi_current||0;if(rsi<rMn||rsi>rMx)return false;
    var prc=d.curr_price||0;if(prc<pMn||prc>pMx)return false;
    return true;
  });
  if(currentSort.col){
    var dir=currentSort.dir==='asc'?1:-1;
    fd.sort(function(a,b){
      var va,vb;
      switch(currentSort.col){
        case'ticker':return dir*(a.ticker||'').localeCompare(b.ticker||'');
        case'type':va=(a.div_type||'').includes('bull')?1:0;vb=(b.div_type||'').includes('bull')?1:0;break;
        case'status':va=a.status==='confirmed'?1:0;vb=b.status==='confirmed'?1:0;break;
        case'prev_rsi':va=a.prev_rsi||0;vb=b.prev_rsi||0;break;
        case'curr_rsi':va=a.curr_rsi||0;vb=b.curr_rsi||0;break;
        case'rsi_current':va=a.rsi_current||0;vb=b.rsi_current||0;break;
        case'curr_price':va=a.curr_price||0;vb=b.curr_price||0;break;
        case'date_detected':return dir*(a.date_detected||'').localeCompare(b.date_detected||'');
        default:va=0;vb=0;
      }
      return dir*(va-vb);
    });
  }
  rT(fd);
}
['rsi-min','rsi-max'].forEach(function(id){document.getElementById(id).addEventListener('input',function(){
  var mn=+document.getElementById('rsi-min').value,mx=+document.getElementById('rsi-max').value;
  document.getElementById('rsi-min-val').textContent=mn;
  document.getElementById('rsi-max-val').textContent=mx;
  var f2=document.getElementById('rsi-fill');f2.style.left=mn+'%';f2.style.width=(mx-mn)+'%';aF()})});
['price-min','price-max'].forEach(function(id){document.getElementById(id).addEventListener('input',function(){
  var mn=+document.getElementById('price-min').value,mx=+document.getElementById('price-max').value;
  document.getElementById('price-min-val').textContent=mn;
  document.getElementById('price-max-val').textContent=mx;
  var f2=document.getElementById('price-fill');f2.style.left=(mn/200*100)+'%';f2.style.width=((mx-mn)/200*100)+'%';aF()})});
document.querySelectorAll('th.sortable').forEach(function(th){th.addEventListener('click',function(){
  var col=th.dataset.sort;
  if(currentSort.col===col)currentSort.dir=currentSort.dir==='asc'?'desc':'asc';
  else currentSort={col:col,dir:'desc'};
  document.querySelectorAll('th.sortable').forEach(function(t){t.classList.remove('asc','desc')});
  th.classList.add(currentSort.dir);aF()})});


// Render table
function rT(data){
  const tb=document.getElementById('tb');tb.innerHTML='';
  document.getElementById('rc').textContent=data.length+' results';
  data.slice(0,500).forEach(d=>{
    const tr=document.createElement('tr');
    tr.onclick=()=>{document.querySelectorAll('tbody tr').forEach(r=>r.classList.remove('sel'));tr.classList.add('sel');sD(d)};
    const ib=(d.div_type||'').includes('bull');
    const rn=d.rsi_current||0;
    let rc='color:var(--t2)';
    if(rn<30)rc='color:var(--grn)';else if(rn>70)rc='color:var(--red)';else if(rn<50)rc='color:var(--amb)';
    tr.innerHTML=`<td><span class="tk">${d.ticker}</span>${d.flag?`<span style="font-size:7px;background:#ffab0033;color:#ffab00;padding:1px 4px;border-radius:2px;margin-left:4px">${d.flag}</span>`:``}<span class="ex ${(d.exchange||'').toLowerCase()}">${d.exchange||''}</span></td><td><span class="db ${ib?'bu':'be'}">${ib?'‚ñ≤ BULL':'‚ñº BEAR'}</span></td><td><span class="sb ${d.status==='confirmed'?'cf':'dt'}">${(d.status||'').toUpperCase()}</span></td><td style="color:var(--t2)">${(d.prev_rsi||0).toFixed(1)}</td><td style="color:var(--t2)">${(d.curr_rsi||0).toFixed(1)}</td><td style="${rc};font-weight:600">${rn.toFixed(1)}</td><td>${(d.curr_price||0).toFixed(2)}</td><td style="color:var(--t3)">${(d.date_detected||'').substring(0,10)}</td>`;
    tb.appendChild(tr);
  });
}

// Detail
function sD(d){
  const rn=d.rsi_current||0;
  let gc='var(--grn)';if(rn>50)gc='var(--amb)';if(rn>70)gc='var(--red)';
  const p=d.curr_price||0, pp=d.prev_price||0;
  document.getElementById('dp').innerHTML=`
    <div style="padding:16px;border-bottom:1px solid var(--brd)"><div class="dtn">${d.ticker}<span class="ex ${(d.exchange||'').toLowerCase()}" style="font-size:9px;margin-left:8px">${d.exchange||''}</span></div><div class="dts">${(d.div_type||'').toUpperCase().replace('_',' ')} ¬∑ MONTHLY${d.sector&&d.sector!=='Unknown'?' ¬∑ '+d.sector:''}</div></div>
    <div class="dg"><div class="dc"><div class="dcl">Status</div><div class="dcv" style="color:${d.status==='confirmed'?'var(--grn)':'var(--amb)'}">${(d.status||'').toUpperCase()}</div></div><div class="dc"><div class="dcl">Bars</div><div class="dcv">${d.bars_elapsed||0}/24</div></div><div class="dc"><div class="dcl">Price</div><div class="dcv">$${p.toFixed(2)}</div></div><div class="dc"><div class="dcl">Prev</div><div class="dcv" style="color:var(--t2)">$${pp.toFixed(2)}</div></div><div class="dc"><div class="dcl">RSI Div</div><div class="dcv">${(d.curr_rsi||0).toFixed(1)}</div></div><div class="dc"><div class="dcl">RSI Prev</div><div class="dcv" style="color:var(--t2)">${(d.prev_rsi||0).toFixed(1)}</div></div></div>
    <div class="rg"><div class="fl">RSI NOW <span style="color:${gc};font-size:12px;font-weight:700">${rn.toFixed(1)}</span></div><div class="rgb"><div class="rgf" style="width:${rn}%;background:${gc}"></div><div class="rgm" style="left:${rn}%"></div></div><div class="rgl"><span>0</span><span>30</span><span>50</span><span>70</span><span>100</span></div></div>
    <div class="dtl"><div class="fl" style="margin-bottom:10px">TIMELINE</div><div class="ti"><div class="td2" style="background:var(--amb)"></div><div><div>Divergence detected</div><div style="color:var(--t3);font-size:8px;margin-top:2px">${(d.date_detected||'').substring(0,10)}</div></div></div>${d.status==='confirmed'?`<div class="ti"><div class="td2" style="background:var(--grn);box-shadow:0 0 12px #00e67644"></div><div><div style="color:var(--grn)">RSI broke 50 ‚úì</div><div style="color:var(--t3);font-size:8px;margin-top:2px">${(d.break_date||'').substring(0,10)}</div></div></div>`:`<div class="ti"><div class="td2" style="background:var(--brd2)"></div><div><div style="color:var(--t3)">Waiting RSI break 50...</div></div></div>`}</div>
    <div class="da"><button class="ab" onclick="window.open('https://www.tradingview.com/chart/?symbol=${d.exchange==='PA'?'EURONEXT:':''}${d.ticker}','_blank')">OPEN IN TRADINGVIEW</button></div>`;
}

// ===== GLOBE INTERACTIVITY =====
function flyTo(lat,lng,label){
  if(!myGlobe) return;
  myGlobe.pointOfView({lat:lat,lng:lng,altitude:1.2},1200);
}
function flyReset(){
  if(!myGlobe) return;
  myGlobe.pointOfView({lat:30,lng:10,altitude:2.2},1200);
  document.getElementById('mep').classList.remove('on');
}

// Globe search
var gsInput=document.getElementById('globe-search');
var gsResults=document.getElementById('globe-search-results');
if(gsInput){
  gsInput.addEventListener('input',function(){
    var q=this.value.toLowerCase().trim();
    if(!q){gsResults.style.display='none';return;}
    var matches=EXS.filter(function(ex){
      return ex.n.toLowerCase().includes(q)||ex.c.toLowerCase().includes(q)||ex.ci.toLowerCase().includes(q)||ex.co.toLowerCase().includes(q);
    });
    if(!matches.length){gsResults.style.display='none';return;}
    gsResults.style.display='block';
    gsResults.innerHTML=matches.map(function(ex){
      var drops=AD.filter(function(d){return d.exchange===ex.c});
      return '<div class="gs-item" onclick="flyTo('+ex.la+','+ex.lo+',\''+ex.c+'\');gsClick(\''+ex.c+'\')"><div><span style="color:'+ex.cl+';font-weight:700;font-family:Outfit">'+ex.c+'</span> <span style="color:var(--t3)">'+ex.ci+'</span></div><div style="font-weight:600">'+drops.length+'</div></div>';
    }).join('');
  });
  gsInput.addEventListener('blur',function(){setTimeout(function(){gsResults.style.display='none'},200)});
}
function gsClick(code){
  gsInput.value='';gsResults.style.display='none';
  var ex=EXS.find(function(e){return e.c===code});
  if(ex){
    var drops=AD.filter(function(d){return d.exchange===ex.c});
    var bulls=drops.filter(function(d){return(d.div_type||'').includes('bull')}).length;
    var pt=Object.assign({},ex,{total:drops.length,bulls:bulls,bears:drops.length-bulls,drops:drops});
    setTimeout(function(){oMP(pt)},600);
  }
}

// Update HUD cockpit
function updGlobeStats(){
  var bulls=AD.filter(function(d){return(d.div_type||'').includes('bull')}).length;
  var bears=AD.length-bulls;
  var conf=AD.filter(function(d){return d.status==='confirmed'}).length;
  var bp=AD.length>0?(bulls/AD.length*100):50;
  var confRate=AD.length>0?(conf/AD.length*100):0;
  
  // Top HUD metrics
  var el;
  el=document.getElementById('h-total');if(el)el.textContent=AD.length;
  el=document.getElementById('h-bull');if(el)el.textContent=bulls;
  el=document.getElementById('h-bear');if(el)el.textContent=bears;
  el=document.getElementById('h-bull-bar');if(el)el.style.width=bp+'%';
  el=document.getElementById('h-bear-bar');if(el)el.style.width=(100-bp)+'%';
  
  // Sentiment
  el=document.getElementById('h-sent');
  if(el){
    var sentText=bp>60?'BULLISH':bp<40?'BEARISH':'NEUTRAL';
    var sentCol=bp>60?'var(--grn)':bp<40?'var(--red)':'var(--amb)';
    el.innerHTML='<span style="color:'+sentCol+'">'+sentText+'</span>';
  }
  
  // Active exchanges count
  var activeExc=new Set(AD.map(function(d){return d.exchange})).size;
  el=document.getElementById('h-exc');if(el)el.textContent=activeExc+'/'+EXS.length;
  
  // Confirm rate
  el=document.getElementById('h-rate');if(el)el.textContent=confRate.toFixed(0)+'%';
  
  // === LEFT: Exchange ranking ===
  var ranking=document.getElementById('hud-ranking');
  if(ranking){
    var counts={};
    AD.forEach(function(d){counts[d.exchange]=(counts[d.exchange]||0)+1});
    var sorted=Object.entries(counts).sort(function(a,b){return b[1]-a[1]});
    var maxCount=sorted.length>0?sorted[0][1]:1;
    ranking.innerHTML=sorted.slice(0,12).map(function(entry,i){
      var code=entry[0],count=entry[1];
      var exInfo=EXS.find(function(e){return e.c===code});
      var col=exInfo?exInfo.cl:'var(--t2)';
      var pct=(count/maxCount*100).toFixed(0);
      var medal=i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':'';
      return '<div class="hud-rank-item" style="animation-delay:'+(i*0.05)+'s" onclick="flyTo('+(exInfo?exInfo.la:0)+','+(exInfo?exInfo.lo:0)+',\''+code+'\')">'
        +'<div class="hud-rank-pos" style="color:'+col+'">'+(medal||(i+1))+'</div>'
        +'<div style="flex:1;min-width:0"><div style="font-family:Outfit;font-weight:700;font-size:10px;color:'+col+'">'+code+'</div>'
        +'<div class="hud-rank-bar"><div class="hud-rank-fill" style="width:'+pct+'%;background:'+col+';box-shadow:0 0 6px '+col+'"></div></div></div>'
        +'<div class="hud-rank-count" style="color:'+col+'">'+count+'</div></div>';
    }).join('');
  }
  
  // === RIGHT: Live feed ===
  var feed=document.getElementById('hud-feed');
  if(feed){
    var recent=AD.slice(0,25);
    feed.innerHTML=recent.map(function(d,i){
      var ib=(d.div_type||'').includes('bull');
      var rn=d.rsi_current||0;
      var rc='color:var(--t2)';if(rn<30)rc='color:var(--grn)';else if(rn>70)rc='color:var(--red)';else if(rn<50)rc='color:var(--amb)';
      var bgCol=ib?'var(--grn2)':'var(--red2)';
      var txCol=ib?'var(--grn)':'var(--red)';
      return '<div class="hud-feed-item" style="animation-delay:'+(i*0.04)+'s" onclick="window.open(\'https://www.tradingview.com/chart/?symbol='+(d.exchange==='PA'?'EURONEXT:':'')+d.ticker+'\',\'_blank\')">'
        +'<div style="display:flex;align-items:center;gap:6px"><span class="hud-feed-ticker">'+d.ticker+'</span>'
        +'<span class="hud-feed-badge" style="background:'+bgCol+';color:'+txCol+'">'+(ib?'‚ñ≤':'‚ñº')+'</span>'
        +'<span style="font-size:7px;color:var(--t3)">'+d.exchange+'</span></div>'
        +'<div style="display:flex;align-items:center;gap:8px"><span class="hud-feed-rsi" style="'+rc+'">'+rn.toFixed(1)+'</span></div></div>';
    }).join('');
  }
  
  // === BOTTOM: Gauges ===
  drawGauge('gauge-bull',bp/100,'#00e676','#ff3d5a');
  document.getElementById('gv-bull').innerHTML='<span style="color:'+(bp>50?'var(--grn)':'var(--red)')+'">'+bp.toFixed(0)+'%</span>';
  
  drawGauge('gauge-conf',confRate/100,'#ffab00','#1e1e30');
  document.getElementById('gv-conf').innerHTML='<span style="color:var(--amb)">'+confRate.toFixed(0)+'%</span>';
  
  var avgRsi=0;
  if(AD.length>0){var sum=0;AD.forEach(function(d){sum+=(d.rsi_current||50)});avgRsi=sum/AD.length;}
  drawGauge('gauge-rsi',avgRsi/100,avgRsi<40?'#00e676':avgRsi>60?'#ff3d5a':'#ffab00','#1e1e30');
  document.getElementById('gv-rsi').innerHTML='<span style="color:'+(avgRsi<40?'var(--grn)':avgRsi>60?'var(--red)':'var(--amb)')+'">'+avgRsi.toFixed(1)+'</span>';
  
  var heat=Math.min(1,AD.length/5000);
  drawGauge('gauge-heat',heat,'#18ffff','#1e1e30');
  document.getElementById('gv-heat').innerHTML='<span style="color:var(--cyn)">'+(heat*100).toFixed(0)+'%</span>';
}

function drawGauge(id,pct,activeCol,bgCol){
  var canvas=document.getElementById(id);if(!canvas)return;
  var ctx=canvas.getContext('2d');
  var w=canvas.width,h=canvas.height;
  var cx=w/2,cy=h-5,r=40;
  ctx.clearRect(0,0,w,h);
  // Background arc
  ctx.beginPath();ctx.arc(cx,cy,r,Math.PI,0);ctx.lineWidth=6;ctx.strokeStyle=bgCol;ctx.stroke();
  // Active arc
  var angle=Math.PI+Math.PI*Math.max(0,Math.min(1,pct));
  ctx.beginPath();ctx.arc(cx,cy,r,Math.PI,angle);ctx.lineWidth=6;ctx.strokeStyle=activeCol;
  ctx.shadowColor=activeCol;ctx.shadowBlur=10;ctx.stroke();ctx.shadowBlur=0;
  // Needle
  var nx=cx+r*0.7*Math.cos(angle);var ny=cy+r*0.7*Math.sin(angle);
  ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(nx,ny);ctx.lineWidth=2;ctx.strokeStyle='#fff';ctx.stroke();
  ctx.beginPath();ctx.arc(cx,cy,3,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();
}

// Add arcs between exchanges - web of connections
function updArcs(){
  if(!myGlobe)return;
  var arcs=[];
  // Connect all active exchanges to their nearest neighbors
  var active=EXS.filter(function(ex){
    return AD.filter(function(d){return d.exchange===ex.c}).length>5;
  });
  // Connect to top 3 exchanges
  var sorted=active.map(function(ex){
    return{ex:ex,count:AD.filter(function(d){return d.exchange===ex.c}).length};
  }).sort(function(a,b){return b.count-a.count});
  
  var hubs=sorted.slice(0,3);
  sorted.forEach(function(item,i){
    if(i<3)return;
    // Connect to nearest hub
    var hub=hubs[0];
    arcs.push({
      startLat:hub.ex.la,startLng:hub.ex.lo,
      endLat:item.ex.la,endLng:item.ex.lo,
      color:[hub.ex.cl+'88',item.ex.cl+'88'],
      stroke:Math.max(0.4,Math.min(2,item.count/80)),
      alt:0.08+Math.random()*0.2
    });
  });
  // Connect hubs to each other
  for(var i=0;i<hubs.length;i++){
    for(var j=i+1;j<hubs.length;j++){
      arcs.push({
        startLat:hubs[i].ex.la,startLng:hubs[i].ex.lo,
        endLat:hubs[j].ex.la,endLng:hubs[j].ex.lo,
        color:[hubs[i].ex.cl+'bb',hubs[j].ex.cl+'bb'],
        stroke:2,
        alt:0.2+Math.random()*0.1
      });
    }
  }
  
  myGlobe
    .arcsData(arcs)
    .arcStartLat('startLat').arcStartLng('startLng')
    .arcEndLat('endLat').arcEndLng('endLng')
    .arcColor('color')
    .arcStroke('stroke')
    .arcAltitude('alt')
    .arcDashLength(0.6)
    .arcDashGap(0.3)
    .arcDashAnimateTime(1500);
}

// Enhanced country hover - highlight polygon
var hoveredCountry=null;
function setupCountryHover(){
  if(!myGlobe)return;
  myGlobe.onPolygonHover(function(poly){
    if(hoveredCountry===poly)return;
    hoveredCountry=poly;
    myGlobe.polygonCapColor(function(p){
      return p===poly?'rgba(24,255,255,0.12)':'rgba(24,255,255,0.04)';
    });
    myGlobe.polygonStrokeColor(function(p){
      return p===poly?'rgba(24,255,255,0.5)':'rgba(24,255,255,0.15)';
    });
  });
  // Click country to find its exchange
  myGlobe.onPolygonClick(function(poly){
    if(!poly||!poly.properties)return;
    var name=(poly.properties.ADMIN||poly.properties.name||'').toLowerCase();
    var match=EXS.find(function(ex){return ex.co.toLowerCase().includes(name)||name.includes(ex.co.toLowerCase())});
    if(match){
      var drops=AD.filter(function(d){return d.exchange===match.c});
      var bulls=drops.filter(function(d){return(d.div_type||'').includes('bull')}).length;
      var pt=Object.assign({},match,{total:drops.length,bulls:bulls,bears:drops.length-bulls,drops:drops});
      oMP(pt);
    }
  });
}
function initGlobe(){
  if(globeInited) {
    // Just resize on re-visit
    if(myGlobe){
      const el=document.getElementById('gc');
      myGlobe.width(el.clientWidth);
      myGlobe.height(el.clientHeight);
    }
    return;
  }
  globeInited=true;

  const el=document.getElementById('gc');
  console.log('Globe container:', el.clientWidth, el.clientHeight);

  myGlobe = Globe()(el)
    .backgroundColor('#000005')
    .globeImageUrl('https://cdn.jsdelivr.net/npm/three-globe/example/img/earth-night.jpg')
    .bumpImageUrl('https://cdn.jsdelivr.net/npm/three-globe/example/img/earth-topology.png')
    .showAtmosphere(true)
    .atmosphereColor('#18ffff')
    .atmosphereAltitude(0.15)
    .width(el.clientWidth)
    .height(el.clientHeight)
    // Countries
    .polygonAltitude(0.006)
    .polygonCapColor(()=>'rgba(24,255,255,0.04)')
    .polygonSideColor(()=>'rgba(24,255,255,0.02)')
    .polygonStrokeColor(()=>'rgba(24,255,255,0.15)')
    .polygonLabel(({properties:p})=>{
      const name=p.ADMIN||p.name||p.NAME||'';
      return '<div style="font-family:Outfit,sans-serif;font-size:13px;font-weight:700;color:#18ffff;padding:6px 10px;background:#0a0a0fee;border:1px solid #2a2a45;border-radius:4px">'+name+'</div>';
    })
    // Points - TALL GLOWING COLUMNS
    .pointsData([])
    .pointLat('la').pointLng('lo')
    .pointAltitude('alt')
    .pointRadius('radius')
    .pointColor('cl')
    .pointLabel(d=>{
      return '<div style="font-family:JetBrains Mono,monospace;font-size:11px;padding:12px 16px;background:#0f1018ee;border:1px solid #2a2a45;border-radius:6px;min-width:220px;backdrop-filter:blur(10px)">'
        +'<div style="font-family:Outfit,sans-serif;font-size:16px;font-weight:800;color:'+d.cl+';text-shadow:0 0 20px '+d.cl+'">'+d.n+'</div>'
        +'<div style="font-size:9px;color:#55556a;margin:3px 0 8px">'+d.ci+', '+d.co+'</div>'
        +'<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #1e1e30"><span style="color:#55556a">Total drops</span><span style="font-weight:700;font-size:16px;color:'+d.cl+'">'+d.total+'</span></div>'
        +'<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #1e1e30"><span style="color:#55556a">‚ñ≤ Bullish</span><span style="color:#00e676;font-weight:700;font-size:14px">'+d.bulls+'</span></div>'
        +'<div style="display:flex;justify-content:space-between;padding:4px 0"><span style="color:#55556a">‚ñº Bearish</span><span style="color:#ff3d5a;font-weight:700;font-size:14px">'+d.bears+'</span></div>'
        +'</div>';
    })
    .onPointClick(d=>oMP(d))
    // Rings
    .ringsData([])
    .ringLat('la').ringLng('lo')
    .ringColor(d=>(function(t){return 'rgba('+d.rgb+','+(Math.max(0,1-t))+')';}))
    .ringMaxRadius('maxR')
    .ringPropagationSpeed(2.5)
    .ringRepeatPeriod(1500)
    // Labels - Exchange codes floating above columns
    .labelsData([])
    .labelLat('la').labelLng('lo')
    .labelText(d=>d.c+' ('+d.total+')')
    .labelSize(d=>d.total>100?2.0:d.total>20?1.6:1.2)
    .labelDotRadius(0.4)
    .labelDotOrientation(()=>'bottom')
    .labelColor('cl')
    .labelAltitude(d=>d.alt+0.01)
    .labelResolution(2)
    // HTML markers - glowing badges on top of columns
    .htmlElementsData([])
    .htmlLat('la').htmlLng('lo')
    .htmlAltitude(d=>d.alt+0.02)
    .htmlElement(d=>{
      var el=document.createElement('div');
      el.style.cssText='text-align:center;pointer-events:auto;cursor:pointer;transform:translate(-50%,-50%)';
      if(d.total===0){el.style.display='none';return el;}
      el.innerHTML='<div style="font-family:Outfit,sans-serif;font-weight:900;font-size:14px;color:'+d.cl+';text-shadow:0 0 15px '+d.cl+',0 0 30px '+d.cl+'55;letter-spacing:2px;white-space:nowrap">'+d.c+'</div>'
        +'<div style="font-family:JetBrains Mono,monospace;font-size:11px;font-weight:700;color:#fff;background:'+d.cl+'cc;padding:2px 8px;border-radius:10px;margin-top:2px;display:inline-block;box-shadow:0 0 20px '+d.cl+'88,0 2px 8px rgba(0,0,0,0.5)">'+d.total+'</div>';
      el.onclick=function(){oMP(d)};
      return el;
    });

  // Countries
  fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json')
    .then(r=>r.json())
    .then(d=>{
      const countries = topojson.feature(d, d.objects.countries);
      myGlobe.polygonsData(countries.features.filter(f=>(f.properties.name||'')!=='Antarctica'));
    })
    .catch(e=>console.error('Countries load error:',e));

  // Controls
  myGlobe.controls().autoRotate=false;
  myGlobe.controls().autoRotateSpeed=0;
  myGlobe.controls().enableDamping=true;
  myGlobe.pointOfView({lat:30,lng:10,altitude:2.2});

  updGlobe();
  updGlobeStats();
  setTimeout(function(){updArcs();setupCountryHover()},1000);

  // Resize handler
  window.addEventListener('resize',()=>{
    if(myGlobe){
      const el2=document.getElementById('gc');
      myGlobe.width(el2.clientWidth);
      myGlobe.height(el2.clientHeight);
    }
  });
}

function hexToRgb(h){
  const r=parseInt(h.slice(1,3),16);
  const g=parseInt(h.slice(3,5),16);
  const b=parseInt(h.slice(5,7),16);
  return r+','+g+','+b;
}

function updGlobe(){
  if(!myGlobe)return;
  const pts=EXS.map(ex=>{
    const drops=AD.filter(d=>d.exchange===ex.c);
    const total=drops.length;
    const bulls=drops.filter(d=>(d.div_type||'').includes('bull')).length;
    return Object.assign({},ex,{
      total:total, bulls:bulls, bears:total-bulls, drops:drops,
      alt: total>0 ? Math.max(0.08, Math.min(0.7, total*0.0008+0.05)) : 0.02,
      radius: total>0 ? Math.max(0.4, Math.min(2.0, Math.sqrt(total)*0.06+0.3)) : 0.15
    });
  });
  myGlobe.pointsData(pts);
  myGlobe.labelsData(pts.filter(function(p){return p.total>0}));
  myGlobe.htmlElementsData(pts);
  myGlobe.ringsData(pts.filter(function(p){return p.total>0}).map(function(p){
    return {la:p.la, lo:p.lo, rgb:hexToRgb(p.cl), maxR:Math.max(4,Math.min(10,Math.sqrt(p.total)*0.5+3))};
  }));
}

// Exchange panel
function oMP(ex){
  var drops=ex.drops||AD.filter(function(d){return d.exchange===ex.c});
  var det=drops.filter(function(d){return d.status==='detected'}).length;
  var conf=drops.filter(function(d){return d.status==='confirmed'}).length;
  var bulls=drops.filter(function(d){return(d.div_type||'').includes('bull')}).length;
  var bears=drops.length-bulls;
  var bp=drops.length>0?(bulls/drops.length*100).toFixed(0):50;
  var p=document.getElementById('mep');
  var html='<div class="meph"><div><div class="mept" style="color:'+ex.cl+'">'+ex.n+'</div><div style="font-size:9px;color:var(--t3);margin-top:2px">'+ex.ci+', '+ex.co+'</div></div><button class="mepc" onclick="document.getElementById(\'mep\').classList.remove(\'on\')">‚úï CLOSE</button></div>';
  html+='<div class="meps"><div class="mepsi"><div class="n" style="color:var(--amb)">'+det+'</div><div class="l">Detected</div></div><div class="mepsi"><div class="n" style="color:var(--grn)">'+conf+'</div><div class="l">Confirmed</div></div><div class="mepsi"><div class="n">'+drops.length+'</div><div class="l">Total</div></div></div>';
  // Bull/Bear ratio bar
  html+='<div style="padding:10px 16px;border-bottom:1px solid var(--brd)"><div style="display:flex;justify-content:space-between;font-size:9px;margin-bottom:4px"><span style="color:var(--grn)">‚ñ≤ '+bulls+' Bull ('+bp+'%)</span><span style="color:var(--red)">‚ñº '+bears+' Bear ('+(100-bp)+'%)</span></div><div style="display:flex;height:6px;border-radius:3px;overflow:hidden;background:var(--bg)"><div style="width:'+bp+'%;background:var(--grn)"></div><div style="width:'+(100-bp)+'%;background:var(--red)"></div></div></div>';
  // Search within exchange
  html+='<div style="padding:8px 16px;border-bottom:1px solid var(--brd)"><input type="text" class="sinp" placeholder="Filter tickers..." style="font-size:10px;padding:5px 8px" oninput="filterMep(this.value,\''+ex.c+'\')"></div>';
  html+='<div class="mepl" id="mepl-list">';
  html+=buildMepList(drops);
  html+='</div>';
  p.innerHTML=html;
  p.classList.add('on');
  myGlobe.pointOfView({lat:ex.la,lng:ex.lo,altitude:1.5},1000);
}

function buildMepList(drops){
  var html='';
  drops.slice(0,100).forEach(function(d){
    var ib=(d.div_type||'').includes('bull');
    var rn=d.rsi_current||0;
    var rc='';if(rn<30)rc='color:var(--grn)';else if(rn<50)rc='color:var(--amb)';else if(rn>70)rc='color:var(--red)';
    var stc=d.status==='confirmed'?'color:var(--grn)':'color:var(--amb)';
    html+='<div class="mepi" onclick="window.open(\'https://www.tradingview.com/chart/?symbol='+(d.exchange==='PA'?'EURONEXT:':'')+d.ticker+'\',\'_blank\')"><div><span style="font-family:Outfit;font-weight:700;font-size:12px">'+d.ticker+'</span><span class="db '+(ib?'bu':'be')+'" style="margin-left:6px;font-size:8px">'+(ib?'BULL':'BEAR')+'</span><span style="font-size:7px;margin-left:4px;'+stc+'">'+d.status.toUpperCase()+'</span></div><div style="'+rc+';font-weight:600">'+rn.toFixed(1)+'</div></div>';
  });
  return html;
}

function filterMep(q,exCode){
  q=q.toUpperCase();
  var drops=AD.filter(function(d){return d.exchange===exCode});
  if(q) drops=drops.filter(function(d){return(d.ticker||'').toUpperCase().includes(q)});
  var list=document.getElementById('mepl-list');
  if(list) list.innerHTML=buildMepList(drops);
}

// Sectors
function rS(){
  var c=document.getElementById('scon');
  if(c.children.length) return;
  var map={};
  AD.forEach(function(d){
    var s=d.sector||'Unknown';
    if(!map[s]) map[s]={bu:0,be:0,dr:[]};
    if((d.div_type||'').includes('bull')) map[s].bu++;
    else map[s].be++;
    map[s].dr.push(d);
  });
  Object.entries(map).sort(function(a,b){return b[1].dr.length-a[1].dr.length}).forEach(function(entry){
    var n=entry[0], data=entry[1];
    var tot=data.dr.length, bp=(data.bu/tot*100).toFixed(0), col=SCC[n]||'#55556a';
    var cd=document.createElement('div');cd.className='sc';
    var inner='<div class="sch"><div class="sn2" style="color:'+col+'">'+n+'</div><div class="scn">'+tot+'</div></div>';
    inner+='<div class="sbr"><div class="sbb" style="width:'+bp+'%;background:#00e676"></div><div class="sbb" style="width:'+(100-bp)+'%;background:#ff3d5a"></div></div>';
    data.dr.slice(0,5).forEach(function(d){
      var ib=(d.div_type||'').includes('bull');
      var rn=d.rsi_current||0;
      var rc='';if(rn<30)rc='color:#00e676';else if(rn<50)rc='color:#ffab00';else if(rn>70)rc='color:#ff3d5a';
      inner+='<div class="sdi"><div><span class="sdt2">'+d.ticker+'</span><span class="ex '+(d.exchange||'').toLowerCase()+'">'+d.exchange+'</span><span class="db '+(ib?'bu':'be')+'" style="margin-left:6px">'+(ib?'‚ñ≤':'‚ñº')+'</span></div><div style="'+rc+';font-weight:600">'+rn.toFixed(1)+'</div></div>';
    });
    if(tot>5) inner+='<div class="se2">Show all '+tot+' ‚Üí</div>';
    cd.innerHTML=inner;
    c.appendChild(cd);
  });
}

// GO
loadData();

// ===== SECTORS BUBBLE VISUALIZATION =====
var bubbleSim, bubbleNodes=[], currentLevel='sectors', currentSector=null;
var sectorColors={
  'Technology':'#448aff','Financial Services':'#00e676','Healthcare':'#e040fb',
  'Industrials':'#ffab00','Consumer Cyclical':'#ff6e40','Basic Materials':'#69f0ae',
  'Consumer Defensive':'#40c4ff','Communication Services':'#7c4dff',
  'Real Estate':'#ffd740','Energy':'#ff4081','Utilities':'#18ffff','Unknown':'#555'
};

function getSectorColor(sector){return sectorColors[sector]||'#18ffff'}

function buildBubbleData(drops){
  var sMap={};
  drops.forEach(function(d){
    var s=d.sector||'Unknown';
    if(!sMap[s])sMap[s]={name:s,count:0,bulls:0,bears:0,tickers:{},industries:{}};
    sMap[s].count++;
    var t=d.div_type||'';
    if(t.includes('bull'))sMap[s].bulls++;
    if(t.includes('bear'))sMap[s].bears++;
    sMap[s].tickers[d.ticker]=1;
    var ind=d.industry||'Unknown';
    if(!sMap[s].industries[ind])sMap[s].industries[ind]={count:0,bulls:0,bears:0,tickers:{}};
    sMap[s].industries[ind].count++;
    if(t.includes('bull'))sMap[s].industries[ind].bulls++;
    if(t.includes('bear'))sMap[s].industries[ind].bears++;
    sMap[s].industries[ind].tickers[d.ticker]=1;
  });
  return Object.values(sMap).map(function(s){
    s.tickerCount=Object.keys(s.tickers).length;
    Object.values(s.industries).forEach(function(ind){ind.tickerCount=Object.keys(ind.tickers).length});
    return s;
  }).sort(function(a,b){return b.count-a.count});
}

function getBubbleColor(d){
  if(d.count===0)return'#555';
  var ratio=d.bulls/(d.bulls+d.bears||1);
  if(ratio>0.6)return'#00e676';
  if(ratio<0.4)return'#ff3d5a';
  return'#ffab00';
}

function initBubbles(){
  if(!window.AD||!window.AD.length||!window.AD.some(function(d){return d.sector&&d.sector!=='Unknown'})){
    window.AD=[
      {sector:'Technology',industry:'Software',div_type:'bullish',ticker:'AAPL',exchange:'US'},
      {sector:'Technology',industry:'Software',div_type:'bearish',ticker:'MSFT',exchange:'US'},
      {sector:'Technology',industry:'Semiconductors',div_type:'bullish',ticker:'NVDA',exchange:'US'},
      {sector:'Technology',industry:'Software',div_type:'bullish',ticker:'CRM',exchange:'US'},
      {sector:'Technology',industry:'Hardware',div_type:'bearish',ticker:'DELL',exchange:'US'},
      {sector:'Financial Services',industry:'Banks',div_type:'bearish',ticker:'JPM',exchange:'US'},
      {sector:'Financial Services',industry:'Banks',div_type:'bearish',ticker:'BAC',exchange:'US'},
      {sector:'Financial Services',industry:'Insurance',div_type:'bullish',ticker:'AXA',exchange:'PA'},
      {sector:'Financial Services',industry:'Asset Mgmt',div_type:'bullish',ticker:'BLK',exchange:'US'},
      {sector:'Healthcare',industry:'Pharma',div_type:'bullish',ticker:'PFE',exchange:'US'},
      {sector:'Healthcare',industry:'Pharma',div_type:'bearish',ticker:'JNJ',exchange:'US'},
      {sector:'Healthcare',industry:'Biotech',div_type:'bullish',ticker:'AMGN',exchange:'US'},
      {sector:'Industrials',industry:'Aerospace',div_type:'bearish',ticker:'BA',exchange:'US'},
      {sector:'Industrials',industry:'Machinery',div_type:'bullish',ticker:'CAT',exchange:'US'},
      {sector:'Industrials',industry:'Defense',div_type:'bearish',ticker:'LMT',exchange:'US'},
      {sector:'Consumer Cyclical',industry:'Auto',div_type:'bullish',ticker:'TSLA',exchange:'US'},
      {sector:'Consumer Cyclical',industry:'Retail',div_type:'bearish',ticker:'AMZN',exchange:'US'},
      {sector:'Consumer Cyclical',industry:'Luxury',div_type:'bullish',ticker:'MC',exchange:'PA'},
      {sector:'Energy',industry:'Oil',div_type:'bearish',ticker:'XOM',exchange:'US'},
      {sector:'Energy',industry:'Oil',div_type:'bearish',ticker:'CVX',exchange:'US'},
      {sector:'Energy',industry:'Gas',div_type:'bullish',ticker:'TTE',exchange:'PA'},
      {sector:'Basic Materials',industry:'Mining',div_type:'bullish',ticker:'BHP',exchange:'ASX'},
      {sector:'Basic Materials',industry:'Chemicals',div_type:'bearish',ticker:'DOW',exchange:'US'},
      {sector:'Communication Services',industry:'Media',div_type:'bullish',ticker:'GOOG',exchange:'US'},
      {sector:'Communication Services',industry:'Telecom',div_type:'bearish',ticker:'T',exchange:'US'},
      {sector:'Consumer Defensive',industry:'Food',div_type:'bullish',ticker:'KO',exchange:'US'},
      {sector:'Consumer Defensive',industry:'Staples',div_type:'bearish',ticker:'PG',exchange:'US'},
      {sector:'Real Estate',industry:'REITs',div_type:'bullish',ticker:'AMT',exchange:'US'},
      {sector:'Real Estate',industry:'Commercial',div_type:'bearish',ticker:'SPG',exchange:'US'},
      {sector:'Utilities',industry:'Electric',div_type:'bullish',ticker:'NEE',exchange:'US'},
      {sector:'Utilities',industry:'Water',div_type:'bearish',ticker:'AWK',exchange:'US'},
    ];
  }
  var con=document.getElementById('scon');
  if(!con||con.offsetWidth<10)return;
  var W=con.offsetWidth, H=con.offsetHeight;
  var svg=d3.select('#bubble-svg').attr('width',W).attr('height',H);
  svg.selectAll('*').remove();
  
  var data=buildBubbleData(window.AD);
  var maxC=d3.max(data,function(d){return d.count})||1;
  var scale=d3.scaleSqrt().domain([0,maxC]).range([20,Math.min(W,H)*0.18]);
  
  bubbleNodes=data.map(function(d){
    return{...d, r:scale(d.count), x:W/2+Math.random()*100-50, y:H/2+Math.random()*100-50};
  });

  // Stats bar
  var totalDrops=data.reduce(function(a,b){return a+b.count},0);
  var totalBulls=data.reduce(function(a,b){return a+b.bulls},0);
  var totalBears=data.reduce(function(a,b){return a+b.bears},0);
  document.getElementById('sstats').innerHTML=
    '<div class="ss-card"><div class="ss-val" style="color:#18ffff">'+data.length+'</div><div class="ss-lbl">SECTORS</div></div>'+
    '<div class="ss-card"><div class="ss-val" style="color:#e8e8f0">'+totalDrops+'</div><div class="ss-lbl">DROPS</div></div>'+
    '<div class="ss-card"><div class="ss-val" style="color:#00e676">'+totalBulls+'</div><div class="ss-lbl">BULL</div></div>'+
    '<div class="ss-card"><div class="ss-val" style="color:#ff3d5a">'+totalBears+'</div><div class="ss-lbl">BEAR</div></div>';

  // Force simulation
  bubbleSim=d3.forceSimulation(bubbleNodes)
    .force('charge',d3.forceManyBody().strength(function(d){return-d.r*1.5}))
    .force('center',d3.forceCenter(W/2,H/2))
    .force('collision',d3.forceCollide().radius(function(d){return d.r+3}).strength(0.9))
    .force('x',d3.forceX(W/2).strength(0.03))
    .force('y',d3.forceY(H/2).strength(0.03))
    .alphaDecay(0.02)
    .on('tick',ticked);

  var g=svg.selectAll('g.bubble').data(bubbleNodes).enter().append('g').attr('class','bubble').style('cursor','pointer');
  
  // Glow filter
  var defs=svg.append('defs');
  var filter=defs.append('filter').attr('id','glow');
  filter.append('feGaussianBlur').attr('stdDeviation','4').attr('result','blur');
  var merge=filter.append('feMerge');
  merge.append('feMergeNode').attr('in','blur');
  merge.append('feMergeNode').attr('in','SourceGraphic');

  g.append('circle')
    .attr('r',function(d){return d.r})
    .attr('fill',function(d){return getBubbleColor(d)})
    .attr('fill-opacity',0.15)
    .attr('stroke',function(d){return getBubbleColor(d)})
    .attr('stroke-width',1.5)
    .attr('stroke-opacity',0.6)
    .attr('filter','url(#glow)');

  g.append('text')
    .attr('text-anchor','middle')
    .attr('dy','-0.3em')
    .attr('fill',function(d){return getSectorColor(d.name)})
    .attr('font-family','Outfit')
    .attr('font-weight','800')
    .attr('font-size',function(d){return Math.max(7,Math.min(13,d.r/4))+'px'})
    .attr('letter-spacing','0.5px')
    .text(function(d){return d.name.length>14?d.name.substring(0,12)+'..':d.name});
  
  g.append('text')
    .attr('text-anchor','middle')
    .attr('dy','0.9em')
    .attr('fill','#8888a0')
    .attr('font-family','JetBrains Mono')
    .attr('font-size',function(d){return Math.max(6,Math.min(10,d.r/5))+'px'})
    .text(function(d){return d.count+' drops'});

  // Drag
  g.call(d3.drag()
    .on('start',function(ev,d){if(!ev.active)bubbleSim.alphaTarget(0.3).restart();d.fx=d.x;d.fy=d.y})
    .on('drag',function(ev,d){d.fx=ev.x;d.fy=ev.y})
    .on('end',function(ev,d){if(!ev.active)bubbleSim.alphaTarget(0);d.fx=null;d.fy=null})
  );

  // Hover tooltip
  var tip=document.getElementById('stooltip');
  g.on('mouseover',function(ev,d){
    tip.innerHTML='<div class="tt-name" style="color:'+getSectorColor(d.name)+'">'+d.name+'</div>'+
      '<div class="tt-row"><span class="tt-label">Drops</span><span class="tt-val">'+d.count+'</span></div>'+
      '<div class="tt-row"><span class="tt-label">Tickers</span><span class="tt-val">'+d.tickerCount+'</span></div>'+
      '<div class="tt-row"><span class="tt-label">Bull</span><span class="tt-val" style="color:#00e676">'+d.bulls+'</span></div>'+
      '<div class="tt-row"><span class="tt-label">Bear</span><span class="tt-val" style="color:#ff3d5a">'+d.bears+'</span></div>'+
      '<div class="tt-row"><span class="tt-label">Industries</span><span class="tt-val">'+Object.keys(d.industries).length+'</span></div>';
    tip.classList.add('show');
  }).on('mousemove',function(ev){
    tip.style.left=(ev.offsetX+15)+'px';tip.style.top=(ev.offsetY-10)+'px';
  }).on('mouseout',function(){tip.classList.remove('show')});

  // Click to drill into sector
  g.on('click',function(ev,d){
    ev.stopPropagation();
    drillSector(d);
  });

  currentLevel='sectors';
  currentSector=null;
  function ticked(){
    svg.selectAll('g.bubble').attr('transform',function(d){return'translate('+d.x+','+d.y+')'});
  }
}

function drillSector(sector){
  currentLevel='industries';
  currentSector=sector;
  var con=document.getElementById('scon');
  var W=con.offsetWidth, H=con.offsetHeight;
  var svg=d3.select('#bubble-svg');
  svg.selectAll('*').remove();

  // Breadcrumb
  document.getElementById('bc').innerHTML=
    '<span class="bc-item" onclick="resetBubbles()">ALL SECTORS</span>'+
    '<span class="bc-sep">‚Ä∫</span>'+
    '<span class="bc-item active">'+sector.name+'</span>';

  // Stats
  document.getElementById('sstats').innerHTML=
    '<div class="ss-card"><div class="ss-val" style="color:'+getSectorColor(sector.name)+'">'+sector.name+'</div><div class="ss-lbl">SECTOR</div></div>'+
    '<div class="ss-card"><div class="ss-val">'+sector.count+'</div><div class="ss-lbl">DROPS</div></div>'+
    '<div class="ss-card"><div class="ss-val" style="color:#00e676">'+sector.bulls+'</div><div class="ss-lbl">BULL</div></div>'+
    '<div class="ss-card"><div class="ss-val" style="color:#ff3d5a">'+sector.bears+'</div><div class="ss-lbl">BEAR</div></div>';

  var indData=Object.entries(sector.industries).map(function(e){return{name:e[0],...e[1]}});
  indData.sort(function(a,b){return b.count-a.count});
  var maxC=d3.max(indData,function(d){return d.count})||1;
  var scale=d3.scaleSqrt().domain([0,maxC]).range([15,Math.min(W,H)*0.15]);
  
  var nodes=indData.map(function(d){
    return{...d, r:scale(d.count), x:W/2+Math.random()*80-40, y:H/2+Math.random()*80-40};
  });

  var defs=svg.append('defs');
  var filter=defs.append('filter').attr('id','glow2');
  filter.append('feGaussianBlur').attr('stdDeviation','3').attr('result','blur');
  var merge=filter.append('feMerge');
  merge.append('feMergeNode').attr('in','blur');
  merge.append('feMergeNode').attr('in','SourceGraphic');

  var sim=d3.forceSimulation(nodes)
    .force('charge',d3.forceManyBody().strength(function(d){return-d.r*1.2}))
    .force('center',d3.forceCenter(W/2,H/2))
    .force('collision',d3.forceCollide().radius(function(d){return d.r+2}).strength(0.9))
    .force('x',d3.forceX(W/2).strength(0.04))
    .force('y',d3.forceY(H/2).strength(0.04))
    .alphaDecay(0.025)
    .on('tick',function(){svg.selectAll('g.ind').attr('transform',function(d){return'translate('+d.x+','+d.y+')'})});

  var col=getSectorColor(sector.name);
  var g=svg.selectAll('g.ind').data(nodes).enter().append('g').attr('class','ind').style('cursor','pointer');
  
  g.append('circle')
    .attr('r',function(d){return d.r})
    .attr('fill',function(d){return getBubbleColor(d)})
    .attr('fill-opacity',0.12)
    .attr('stroke',function(d){return getBubbleColor(d)})
    .attr('stroke-width',1)
    .attr('stroke-opacity',0.5)
    .attr('filter','url(#glow2)');

  g.append('text').attr('text-anchor','middle').attr('dy','-0.2em')
    .attr('fill',col).attr('font-family','Outfit').attr('font-weight','700')
    .attr('font-size',function(d){return Math.max(6,Math.min(11,d.r/4))+'px'})
    .text(function(d){return d.name.length>16?d.name.substring(0,14)+'..':d.name});

  g.append('text').attr('text-anchor','middle').attr('dy','0.9em')
    .attr('fill','#8888a0').attr('font-family','JetBrains Mono')
    .attr('font-size',function(d){return Math.max(5,Math.min(9,d.r/5))+'px'})
    .text(function(d){return d.count});

  g.call(d3.drag()
    .on('start',function(ev,d){if(!ev.active)sim.alphaTarget(0.3).restart();d.fx=d.x;d.fy=d.y})
    .on('drag',function(ev,d){d.fx=ev.x;d.fy=ev.y})
    .on('end',function(ev,d){if(!ev.active)sim.alphaTarget(0);d.fx=null;d.fy=null})
  );

  var tip=document.getElementById('stooltip');
  g.on('mouseover',function(ev,d){
    tip.innerHTML='<div class="tt-name" style="color:'+col+'">'+d.name+'</div>'+
      '<div class="tt-row"><span class="tt-label">Drops</span><span class="tt-val">'+d.count+'</span></div>'+
      '<div class="tt-row"><span class="tt-label">Tickers</span><span class="tt-val">'+d.tickerCount+'</span></div>'+
      '<div class="tt-row"><span class="tt-label">Bull</span><span class="tt-val" style="color:#00e676">'+d.bulls+'</span></div>'+
      '<div class="tt-row"><span class="tt-label">Bear</span><span class="tt-val" style="color:#ff3d5a">'+d.bears+'</span></div>';
    tip.classList.add('show');
  }).on('mousemove',function(ev){
    tip.style.left=(ev.offsetX+15)+'px';tip.style.top=(ev.offsetY-10)+'px';
  }).on('mouseout',function(){tip.classList.remove('show')});
}

function resetBubbles(){
  document.getElementById('bc').innerHTML='<span class="bc-item active" onclick="resetBubbles()">ALL SECTORS</span>';
  initBubbles();
}

// Hook into tab switching
var origShowTab=window.showTab;
if(typeof origShowTab==='undefined'){
  // Find existing tab logic
  document.querySelectorAll('.tab[data-tab]').forEach(function(t){
    t.addEventListener('click',function(){
      var tab=this.dataset.tab;
      document.querySelectorAll('.tab').forEach(function(x){x.classList.remove('on')});
      this.classList.add('on');
      document.querySelectorAll('.tcon').forEach(function(x){x.classList.remove('on')});
      var el=document.getElementById('tab-'+tab);
      if(el)el.classList.add('on');
      if(tab==='sectors'){setTimeout(initBubbles,100)}
    });
  });
} else {
  var _origShow=origShowTab;
  window.showTab=function(id){_origShow(id);if(id==='sectors')setTimeout(initBubbles,100)};
}

// Also init when sectors tab clicked
document.querySelectorAll('.tab[data-tab="sectors"]').forEach(function(t){
  t.addEventListener('click',function(){setTimeout(initBubbles,200)});
});


// ===== HYBRID TICKER TAPE (EODHD for Gold/Oil/VIX/DAX/CAC) =====
var EODHD_KEY='6994b3f0073fa9.41012239';
var eodTape=[
  {id:'ti-gold',sym:'GC.COMEX',name:'Gold'},
  {id:'ti-oil',sym:'CL.COMEX',name:'Oil'},
  {id:'ti-vix',sym:'VIX.INDX',name:'VIX'},
  {id:'ti-dax',sym:'GDAXI.INDX',name:'DAX'},
  {id:'ti-cac',sym:'FCHI.INDX',name:'CAC 40'}
];
function fetchEodTape(){
  eodTape.forEach(function(t){
    fetch('/api/quote/'+t.sym)
    .then(function(r){return r.json()})
    .then(function(d){
      var el=document.getElementById(t.id);
      if(!el||!d.close)return;
      var price=parseFloat(d.close);
      var prev=parseFloat(d.previousClose)||price;
      var chg=price-prev;
      var pct=prev?((chg/prev)*100):0;
      var col=chg>=0?'#00e676':'#ff3d5a';
      var sign=chg>=0?'+':'';
      var priceStr=price>1000?price.toLocaleString('en',{minimumFractionDigits:2,maximumFractionDigits:2}):price.toFixed(2);
      el.innerHTML=t.name+' &middot; <span class="tp" style="color:'+col+'">'+priceStr+'</span><span class="tpch" style="color:'+col+'"> '+sign+pct.toFixed(2)+'%</span>';
    }).catch(function(){});
  });
}
fetchEodTape();
setInterval(fetchEodTape,60000);

</script>
</body>
</html><div class="tape" style="display:flex;align-items:center;overflow:hidden">
<div style="flex:1;overflow:hidden">
<div class="tradingview-widget-container"><div class="tradingview-widget-container__widget"></div>
<script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>{"symbols":[{"proName":"FOREXCOM:SPXUSD","title":"S&P 500"},{"proName":"FOREXCOM:NSXUSD","title":"NASDAQ"},{"proName":"BITSTAMP:BTCUSD","title":"BTC"},{"proName":"FX:EURUSD","title":"EUR/USD"}],"showSymbolLogo":false,"isTransparent":true,"displayMode":"adaptive","colorTheme":"dark","locale":"en"}
// ===== PORTFOLIO & WATCHLIST =====
var pfData=JSON.parse(localStorage.getItem('rsi_portfolio')||'[]');
var wlData=JSON.parse(localStorage.getItem('rsi_watchlist')||'[]');

function savePf(){localStorage.setItem('rsi_portfolio',JSON.stringify(pfData))}
function saveWl(){localStorage.setItem('rsi_watchlist',JSON.stringify(wlData))}

function addPfRow(){
  pfData.push({ticker:'',qty:0,buyPrice:0,currentPrice:0});
  savePf();renderPf();
}
function removePfRow(i){pfData.splice(i,1);savePf();renderPf()}
function clearPf(){if(confirm('Clear all portfolio?')){pfData=[];savePf();renderPf()}}

function updatePfField(i,field,val){
  if(field==='ticker')pfData[i][field]=val.toUpperCase();
  else pfData[i][field]=parseFloat(val)||0;
  savePf();renderPf();
}

function fetchPfPrice(i,ticker){
  if(!ticker)return;
  fetch('/api/quote/'+ticker+'.US')
  .then(function(r){return r.json()})
  .then(function(d){
    if(d.close&&d.close!=='NA'){
      pfData[i].currentPrice=parseFloat(d.close);
      savePf();renderPf();
    }
  }).catch(function(){});
}

function renderPf(){
  var body=document.getElementById('pf-body');
  var totalVal=0,totalCost=0;
  var rows='';
  pfData.forEach(function(p,i){
    var val=p.qty*p.currentPrice;
    var cost=p.qty*p.buyPrice;
    var pnl=val-cost;
    var pnlPct=cost>0?((pnl/cost)*100):0;
    totalVal+=val;totalCost+=cost;
    var pnlCol=pnl>=0?'#00e676':'#ff3d5a';
    var sign=pnl>=0?'+':'';
    rows+='<tr>'+
      '<td style="color:#55556a">'+(i+1)+'</td>'+
      '<td><input value="'+p.ticker+'" placeholder="AAPL" onchange="updatePfField('+i+',\'ticker\',this.value)" onblur="fetchPfPrice('+i+',this.value)" style="width:70px;font-weight:700;color:#18ffff"></td>'+
      '<td><input type="number" value="'+(p.qty||'')+'" placeholder="0" onchange="updatePfField('+i+',\'qty\',this.value)" style="width:60px"></td>'+
      '<td><input type="number" value="'+(p.buyPrice||'')+'" placeholder="0.00" step="0.01" onchange="updatePfField('+i+',\'buyPrice\',this.value)" style="width:80px"></td>'+
      '<td style="color:#e8e8f0;font-weight:600">'+(p.currentPrice?'$'+p.currentPrice.toFixed(2):'‚Äî')+'</td>'+
      '<td style="font-weight:600">'+(val?'$'+val.toLocaleString('en',{minimumFractionDigits:2,maximumFractionDigits:2}):'‚Äî')+'</td>'+
      '<td style="color:'+pnlCol+';font-weight:700">'+(cost?sign+'$'+Math.abs(pnl).toFixed(2):'‚Äî')+'</td>'+
      '<td style="color:'+pnlCol+';font-weight:600">'+(cost?sign+pnlPct.toFixed(2)+'%':'‚Äî')+'</td>'+
      '<td><button class="pf-del" onclick="removePfRow('+i+')">√ó</button></td>'+
      '</tr>';
  });
  body.innerHTML=rows;
  var totalPnl=totalVal-totalCost;
  var totalPnlPct=totalCost>0?((totalPnl/totalCost)*100):0;
  var col=totalPnl>=0?'#00e676':'#ff3d5a';
  var s=totalPnl>=0?'+':'';
  document.getElementById('pf-total').textContent='$'+totalVal.toLocaleString('en',{minimumFractionDigits:2,maximumFractionDigits:2});
  document.getElementById('pf-pnl').innerHTML=totalCost?'<span style="color:'+col+'">'+s+'$'+Math.abs(totalPnl).toFixed(2)+' ('+s+totalPnlPct.toFixed(2)+'%)</span>':'';
}

// WATCHLIST
function addWlRow(){
  wlData.push({ticker:'',targetBuy:0,targetSell:0,currentPrice:0,notes:''});
  saveWl();renderWl();
}
function removeWlRow(i){wlData.splice(i,1);saveWl();renderWl()}
function clearWl(){if(confirm('Clear all watchlist?')){wlData=[];saveWl();renderWl()}}

function updateWlField(i,field,val){
  if(field==='ticker')wlData[i][field]=val.toUpperCase();
  else if(field==='notes')wlData[i][field]=val;
  else wlData[i][field]=parseFloat(val)||0;
  saveWl();renderWl();
}

function fetchWlPrice(i,ticker){
  if(!ticker)return;
  fetch('/api/quote/'+ticker+'.US')
  .then(function(r){return r.json()})
  .then(function(d){
    if(d.close&&d.close!=='NA'){
      wlData[i].currentPrice=parseFloat(d.close);
      saveWl();renderWl();
    }
  }).catch(function(){});
}

function renderWl(){
  var body=document.getElementById('wl-body');
  var rows='';
  wlData.forEach(function(w,i){
    var signal='';
    if(w.currentPrice&&w.targetBuy&&w.currentPrice<=w.targetBuy)signal='<span class="signal-bull">‚óè BUY ZONE</span>';
    else if(w.currentPrice&&w.targetSell&&w.currentPrice>=w.targetSell)signal='<span class="signal-bear">‚óè SELL ZONE</span>';
    else if(w.currentPrice)signal='<span class="signal-neutral">‚óè WAIT</span>';
    rows+='<tr>'+
      '<td style="color:#55556a">'+(i+1)+'</td>'+
      '<td><input value="'+w.ticker+'" placeholder="TSLA" onchange="updateWlField('+i+',\'ticker\',this.value)" onblur="fetchWlPrice('+i+',this.value)" style="width:70px;font-weight:700;color:#e040fb"></td>'+
      '<td><input type="number" value="'+(w.targetBuy||'')+'" placeholder="0.00" step="0.01" onchange="updateWlField('+i+',\'targetBuy\',this.value)" style="width:80px"></td>'+
      '<td><input type="number" value="'+(w.targetSell||'')+'" placeholder="0.00" step="0.01" onchange="updateWlField('+i+',\'targetSell\',this.value)" style="width:80px"></td>'+
      '<td style="color:#e8e8f0;font-weight:600">'+(w.currentPrice?'$'+w.currentPrice.toFixed(2):'‚Äî')+'</td>'+
      '<td>'+signal+'</td>'+
      '<td><input class="notes-input" value="'+(w.notes||'')+'" placeholder="Notes..." onchange="updateWlField('+i+',\'notes\',this.value)"></td>'+
      '<td><button class="wl-del" onclick="removeWlRow('+i+')">√ó</button></td>'+
      '</tr>';
  });
  body.innerHTML=rows;
  document.getElementById('wl-count').textContent=wlData.length+' items';
}

// Init on load
renderPf();renderWl();

// Refresh prices every 60s
setInterval(function(){
  pfData.forEach(function(p,i){if(p.ticker)fetchPfPrice(i,p.ticker)});
  wlData.forEach(function(w,i){if(w.ticker)fetchWlPrice(i,w.ticker)});
},60000);

</script></div>
</div>
<div style="display:flex;gap:20px;padding:0 16px;align-items:center;flex-shrink:0;border-left:1px solid #1e1e30">
  <div class="tape-item" id="ti-gold">Gold <span class="tp">‚Äî</span></div>
  <div class="tape-sep">|</div>
  <div class="tape-item" id="ti-oil">Oil <span class="tp">‚Äî</span></div>
  <div class="tape-sep">|</div>
  <div class="tape-item" id="ti-vix">VIX <span class="tp">‚Äî</span></div>
  <div class="tape-sep">|</div>
  <div class="tape-item" id="ti-dax">DAX <span class="tp">‚Äî</span></div>
  <div class="tape-sep">|</div>
  <div class="tape-item" id="ti-cac">CAC 40 <span class="tp">‚Äî</span></div>
</div>
</div>
